<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Reader Pro Max</title>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ================== 主题与基础设置 ================== */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --font-sans: 'Inter', -apple-system, sans-serif;
            --font-serif: 'Georgia', serif;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background 0.3s, color 0.3s;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
        }

        /* ================== UI 组件优化 ================== */
        /* 智能 Textarea */
        textarea.auto-grow {
            width: 100%;
            min-height: 200px;
            resize: none;
            /* 禁止手动拉伸 */
            overflow-y: hidden;
            /* 隐藏滚动条 */
            padding: 15px;
            font-family: var(--font-serif);
            font-size: 16px;
            line-height: 1.8;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-main);
            box-sizing: border-box;
            display: block;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-main);
            border-radius: 8px;
            margin-bottom: 16px;
            box-sizing: border-box;
            outline: none;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            filter: brightness(1.1);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-icon {
            padding: 8px;
            background: transparent;
            border: none;
            color: var(--text-sec);
            cursor: pointer;
            border-radius: 50%;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--text-main);
        }

        /* ================== 头像系统 ================== */
        .avatar-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
            background: var(--card-bg);
        }

        .avatar-lg {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            display: block;
        }

        /* ================== 消息通知中心 (Notification Center) ================== */
        #notification-center {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--card-bg);
            border-left: 4px solid var(--primary);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
            color: var(--text-main);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-progress {
            height: 4px;
            background: #e2e8f0;
            margin-top: 8px;
            border-radius: 2px;
            overflow: hidden;
        }

        .toast-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.2s;
        }

        /* ================== 布局细节 ================== */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        /* 响应式阅读器 */
        .reader-layout {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .reader-main {
            flex: 2;
            min-width: 300px;
        }

        .reader-sidebar {
            flex: 1;
            min-width: 250px;
            background: var(--bg);
            padding: 15px;
            border-radius: 8px;
        }

        .highlight {
            background-color: rgba(253, 224, 71, 0.4);
            border-bottom: 2px solid #facc15;
            cursor: pointer;
        }

        /* OCR 对照模式 */
        .ocr-split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 400px;
        }

        .ocr-preview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            border-radius: 8px;
        }

        /* 登录页 */
        .auth-box {
            max-width: 400px;
            margin: 10vh auto;
            text-align: center;
        }
    </style>
</head>

<body>

    <div id="notification-center"></div>

    <div id="auth-container" class="container">
        <div id="view-login" class="card auth-box">
            <h2 style="margin-bottom:10px;">欢迎回来</h2>
            <input type="email" id="login-email" placeholder="邮箱">
            <input type="password" id="login-password" placeholder="密码">
            <button class="btn" style="width:100%; justify-content:center;" onclick="handleLogin()">登录</button>
            <p style="font-size:13px; margin-top:20px;">
                无账号？<span style="color:var(--primary); cursor:pointer;" onclick="switchAuth('signup')">去注册</span>
            </p>
        </div>

        <div id="view-signup" class="card auth-box hidden">
            <h2 style="margin-bottom:10px;">创建账号</h2>
            <input type="email" id="signup-email" placeholder="邮箱">
            <input type="password" id="signup-password" placeholder="密码">
            <button class="btn" style="width:100%; justify-content:center;" onclick="handleSignup()">注册</button>
            <p style="font-size:13px; margin-top:20px;">
                <span style="color:var(--primary); cursor:pointer;" onclick="switchAuth('login')">返回登录</span>
            </p>
        </div>
    </div>

    <div id="app-container" class="container hidden">
        <div class="navbar">
            <div style="font-weight:700; font-size:20px; display:flex; align-items:center; gap:8px;">
                <i class="ph ph-read-cv-logo"></i> SmartReader
            </div>
            <div class="user-profile" onclick="showView('settings')">
                <span id="nav-name" style="font-size:14px; font-weight:500;">User</span>
                <img id="nav-avatar" class="avatar-img" src="" alt="Avatar">
            </div>
        </div>

        <div id="view-dashboard" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>我的文章</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-outline" onclick="triggerGlobalOCR()">
                        <i class="ph ph-upload-simple"></i> 后台识别
                    </button>
                    <button class="btn" onclick="openEditor(null)">
                        <i class="ph ph-pencil-simple"></i> 新建
                    </button>
                </div>
            </div>
            <input type="file" id="global-ocr-input" accept="image/*" class="hidden" onchange="startGlobalOCR()">

            <div id="article-list"
                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px;"></div>
        </div>

        <div id="view-editor" class="hidden card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>编辑文章</h3>
                <button class="btn btn-outline" onclick="showView('dashboard')">取消</button>
            </div>

            <input type="text" id="edit-title" placeholder="文章标题 (必填)">

            <textarea id="edit-content" class="auto-grow" placeholder="输入内容..."></textarea>

            <div style="text-align:right; margin-top:20px;">
                <button class="btn" onclick="saveArticle()"><i class="ph ph-floppy-disk"></i> 保存</button>
            </div>
        </div>

        <div id="view-reader" class="hidden card">
            <div style="margin-bottom:20px; display:flex; justify-content:space-between;">
                <button class="btn btn-outline" onclick="showView('dashboard')"><i class="ph ph-arrow-left"></i>
                    返回</button>
                <button class="btn btn-outline" onclick="editCurrentArticle()"><i class="ph ph-pencil-simple"></i>
                    修改</button>
            </div>
            <h1 id="read-title"></h1>
            <div class="reader-layout">
                <div class="reader-main">
                    <div id="read-content" style="white-space: pre-wrap; font-size:18px; line-height:1.8;"></div>
                </div>
                <div class="reader-sidebar">
                    <h4>笔记</h4>
                    <ul id="notes-ul" style="padding:0; list-style:none;"></ul>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden card" style="max-width:600px; margin:0 auto;">
            <h3>设置</h3>
            <div style="text-align:center; margin-bottom:20px;">
                <img id="setting-avatar" class="avatar-img avatar-lg" src="">
                <p style="font-size:12px; color:var(--text-sec);">头像链接 (支持 JPG/PNG URL)</p>
                <input type="text" id="set-avatar-url" placeholder="输入图片地址..." onchange="previewAvatar(this.value)">
            </div>

            <label>昵称</label>
            <input type="text" id="set-name">

            <label>显示模式</label>
            <select id="theme-select" onchange="changeTheme(this.value)">
                <option value="system">跟随系统</option>
                <option value="light">浅色</option>
                <option value="dark">深色</option>
            </select>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="btn btn-outline" onclick="showView('dashboard')">返回</button>
                <button class="btn" onclick="updateProfile()">保存设置</button>
            </div>
            <button class="btn-text" style="color:var(--danger); margin-top:30px; width:100%;"
                onclick="signOut()">退出登录</button>
        </div>

    </div>

    <script>
        // ================= 配置 (保留你的 Key) =================
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rdGd4ZXVrbGxnZ2xoYXJrdXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzI1MTAsImV4cCI6MjA4MDY0ODUxMH0.R-XORb7qYMZPGLj4ZdPt3bIrI61TgOs7vCyxwGmnCpg'
        const db = supabase.createClient(supabaseUrl, supabaseKey)

        // ================= 全局状态 =================
        let currentUser = null;
        let currentArticleId = null;

        // ================= 1. 通知中心 (核心：解决上传取消问题) =================
        const notify = {
            create: (id, text) => {
                const box = document.getElementById('notification-center');
                const div = document.createElement('div');
                div.id = `toast-${id}`;
                div.className = 'toast';
                div.innerHTML = `
                    <div style="width:100%">
                        <div style="display:flex; justify-content:space-between;">
                            <span>${text}</span>
                            <span id="pct-${id}" style="font-size:12px; color:#666">0%</span>
                        </div>
                        <div class="toast-progress"><div id="bar-${id}" class="toast-bar"></div></div>
                    </div>`;
                box.appendChild(div);
            },
            update: (id, progress, statusText) => {
                const bar = document.getElementById(`bar-${id}`);
                const pct = document.getElementById(`pct-${id}`);
                if (bar) bar.style.width = `${progress * 100}%`;
                if (pct) pct.innerText = statusText || `${(progress * 100).toFixed(0)}%`;
            },
            success: (id, msg, action) => {
                const el = document.getElementById(`toast-${id}`);
                if (el) {
                    el.style.borderLeftColor = 'var(--success)';
                    el.innerHTML = `
                        <div style="display:flex; align-items:center; justify-content:space-between; width:100%">
                            <span>✅ ${msg}</span>
                            ${action ? `<button class="btn btn-outline" style="padding:2px 8px; font-size:12px;" onclick="${action}">查看</button>` : ''}
                            <button class="btn-icon" onclick="this.parentElement.parentElement.parentElement.remove()">✕</button>
                        </div>`;
                    // 5秒后自动消失
                    setTimeout(() => el.remove(), 8000);
                }
            },
            error: (id, msg) => {
                const el = document.getElementById(`toast-${id}`);
                if (el) {
                    el.style.borderLeftColor = 'var(--danger)';
                    el.innerHTML = `<span>❌ ${msg}</span> <button class="btn-icon" onclick="this.parentElement.remove()">✕</button>`;
                }
            }
        };

        // ================= 2. OCR 逻辑 (独立运行) =================
        // 用户可以点击“后台识别”，选择图片，然后继续做别的事
        function triggerGlobalOCR() { document.getElementById('global-ocr-input').click(); }

        async function startGlobalOCR() {
            const file = document.getElementById('global-ocr-input').files[0];
            if (!file) return;

            const taskId = Date.now();
            notify.create(taskId, `正在识别: ${file.name.slice(0, 10)}...`);

            try {
                // 开始识别
                const { data: { text } } = await Tesseract.recognize(file, 'eng+chi_sim', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            notify.update(taskId, m.progress);
                        }
                    }
                });

                // 优化排版：尝试保留段落
                // 原理：Tesseract 常把换行当空格。我们把连续2个换行视为段落。
                const formattedText = text
                    .replace(/([^\n])\n([^\n])/g, '$1 $2') // 移除单次硬回车（合并行）
                    .replace(/\n\n+/g, '\n\n'); // 保留段落

                // 自动保存为新文章
                const title = `OCR: ${file.name} (${new Date().toLocaleTimeString()})`;
                const { data, error } = await db.from('articles').insert({
                    title: title,
                    content: formattedText,
                    user_id: currentUser.id
                }).select();

                if (error) throw error;

                // 通知完成
                notify.success(taskId, '识别完成！已保存到库', `openEditor('${data[0].id}')`);

            } catch (err) {
                console.error(err);
                notify.error(taskId, '识别失败，请重试');
            }

            // 清空input防止重复触发
            document.getElementById('global-ocr-input').value = '';
        }

        // ================= 3. Textarea 自适应脚本 =================
        const tx = document.getElementById('edit-content');
        tx.setAttribute('style', 'height:' + (tx.scrollHeight) + 'px;overflow-y:hidden;');
        tx.addEventListener("input", OnInput, false);

        function OnInput() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        }

        // ================= 常规逻辑 =================
        async function init() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            document.getElementById('theme-select').value = savedTheme;
            changeTheme(savedTheme);

            const { data: { session } } = await db.auth.getSession();
            updateUserState(session?.user);
            db.auth.onAuthStateChange((_event, session) => updateUserState(session?.user));
        }

        function changeTheme(mode) {
            localStorage.setItem('theme', mode);
            const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            isDark ? document.body.setAttribute('data-theme', 'dark') : document.body.removeAttribute('data-theme');
        }

        function updateUserState(user) {
            currentUser = user;
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                // 头像逻辑：优先用 metadata 里的，没有则用 UI Avatars 生成图片
                const meta = user.user_metadata || {};
                // 如果没有头像，使用 ui-avatars 生成真实图片链接
                const defaultAvatar = `https://ui-avatars.com/api/?name=${meta.display_name || user.email}&background=random&color=fff&size=128`;
                const avatarUrl = meta.avatar_url || defaultAvatar;

                document.getElementById('nav-avatar').src = avatarUrl;
                document.getElementById('setting-avatar').src = avatarUrl;
                document.getElementById('set-avatar-url').value = meta.avatar_url || '';

                document.getElementById('nav-name').innerText = meta.display_name || user.email.split('@')[0];
                document.getElementById('set-name').value = meta.display_name || '';

                if (document.querySelectorAll('.hidden').length >= 4) showView('dashboard');
            } else {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('auth-container').classList.remove('hidden');
            }
        }

        function showView(name) {
            ['dashboard', 'editor', 'reader', 'settings'].forEach(id => document.getElementById('view-' + id).classList.add('hidden'));
            document.getElementById('view-' + name).classList.remove('hidden');
            if (name === 'dashboard') loadArticles();
        }

        function switchAuth(type) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-signup').classList.add('hidden');
            document.getElementById('view-' + type).classList.remove('hidden');
        }

        // 登录注册
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
        }

        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            // 注册时写入默认 Display Name
            const { error } = await db.auth.signUp({
                email, password,
                options: { data: { display_name: email.split('@')[0] } }
            });
            if (error) alert(error.message);
            else alert('注册成功');
        }

        async function signOut() { await db.auth.signOut(); location.reload(); }

        // 设置更新
        function previewAvatar(url) { document.getElementById('setting-avatar').src = url; }

        async function updateProfile() {
            const name = document.getElementById('set-name').value;
            const avatar = document.getElementById('set-avatar-url').value;

            const { error } = await db.auth.updateUser({
                data: { display_name: name, avatar_url: avatar }
            });
            if (error) alert('保存失败');
            else { alert('保存成功'); updateUserState(currentUser); }
        }

        // 文章与编辑器
        async function loadArticles() {
            const list = document.getElementById('article-list');
            list.innerHTML = '加载中...';
            const { data } = await db.from('articles').select('*').order('created_at', { ascending: false });

            list.innerHTML = data.map(a => `
                <div class="card" style="margin:0; cursor:pointer;" onclick="openReader('${a.id}')">
                    <h3 style="margin-top:0">${a.title}</h3>
                    <p style="font-size:12px; color:var(--text-sec)">${new Date(a.created_at).toLocaleDateString()}</p>
                    <div style="text-align:right">
                         <button class="btn-icon" onclick="event.stopPropagation(); deleteArticle('${a.id}')"><i class="ph ph-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function deleteArticle(id) {
            if (confirm('删除?')) {
                await db.from('articles').delete().eq('id', id);
                loadArticles();
            }
        }

        async function openEditor(id) {
            showView('editor');
            if (id) {
                const { data } = await db.from('articles').select('*').eq('id', id).single();
                currentArticleId = data.id;
                document.getElementById('edit-title').value = data.title;
                const tx = document.getElementById('edit-content');
                tx.value = data.content;
                tx.style.height = 'auto'; // Reset
                tx.style.height = (tx.scrollHeight) + 'px'; // Auto grow
            } else {
                currentArticleId = null;
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-content').value = '';
            }
        }

        async function saveArticle() {
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;
            if (!title) return alert('标题必填');

            const payload = { title, content, user_id: currentUser.id };
            if (currentArticleId) {
                await db.from('articles').update(payload).eq('id', currentArticleId);
            } else {
                const { data } = await db.from('articles').insert(payload).select();
                currentArticleId = data[0].id;
            }
            openReader(currentArticleId);
        }

        function editCurrentArticle() { openEditor(currentArticleId); }

        // 阅读与笔记
        async function openReader(id) {
            currentArticleId = id;
            showView('reader');
            const { data } = await db.from('articles').select('*').eq('id', id).single();
            document.getElementById('read-title').innerText = data.title;
            // 存原始文本
            document.getElementById('read-content').dataset.raw = data.content;
            loadAnnotations(id);
        }

        async function loadAnnotations(id) {
            const { data: notes } = await db.from('annotations').select('*').eq('article_id', id);
            const div = document.getElementById('read-content');
            const ul = document.getElementById('notes-ul');
            ul.innerHTML = '';
            let html = div.dataset.raw;

            if (notes) {
                notes.forEach(n => {
                    // 简单的列表渲染
                    ul.innerHTML += `<li><b>${n.highlight_text}</b>: ${n.note} <span onclick="deleteNote('${n.id}')" style="color:red;cursor:pointer">×</span></li>`;
                    // 简单高亮
                    html = html.split(n.highlight_text).join(`<span class="highlight" title="${n.note}">${n.highlight_text}</span>`);
                });
            }
            div.innerHTML = html;
        }

        window.deleteNote = async function (id) {
            await db.from('annotations').delete().eq('id', id);
            loadAnnotations(currentArticleId);
        }

        document.getElementById('read-content').addEventListener('mouseup', async () => {
            const text = window.getSelection().toString().trim();
            if (!text) return;
            setTimeout(async () => {
                const note = prompt('添加笔记:');
                if (note) {
                    await db.from('annotations').insert({ article_id: currentArticleId, highlight_text: text, note });
                    loadAnnotations(currentArticleId);
                }
                window.getSelection().removeAllRanges();
            }, 10);
        });

        init();
    </script>
</body>

</html>