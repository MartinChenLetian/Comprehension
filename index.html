<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Reader Pro</title>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ================== CSS å˜é‡ä¸ä¸»é¢˜ç³»ç»Ÿ ================== */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-serif: 'Georgia', 'Times New Roman', serif;
        }

        /* æš—é»‘æ¨¡å¼å˜é‡è¦†ç›– */
        [data-theme="dark"] {
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* ================== å…¨å±€é‡ç½® ================== */
        body {
            font-family: var(--font-sans);
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.5;
        }

        /* å¸ƒå±€å®¹å™¨ */
        .container {
            width: 100%;
            max-width: 1000px;
            /* æ›´å®½çš„å®¹å™¨ */
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        /* è¡¨å•æ§ä»¶ */
        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-main);
            border-radius: 8px;
            margin-bottom: 16px;
            box-sizing: border-box;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary);
        }

        /* æŒ‰é’®ç³»ç»Ÿ */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            border-color: var(--text-sec);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-text {
            background: none;
            color: var(--primary);
            padding: 0;
        }

        .btn-icon {
            padding: 6px;
            border-radius: 4px;
            color: var(--text-sec);
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--text-main);
        }

        /* ================== é¡¶éƒ¨å¯¼èˆªæ  ================== */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-menu {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
        }

        .avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* ================== ç™»å½•/æ³¨å†Œé¡µ (ç²¾ç¾ç‰ˆ) ================== */
        .auth-container {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-card {
            width: 100%;
            max-width: 400px;
            text-align: center;
            padding: 40px 30px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-sub {
            color: var(--text-sec);
            font-size: 14px;
            margin-bottom: 30px;
        }

        /* ================== æ–‡ç« åˆ—è¡¨ ================== */
        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .article-card {
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }

        .article-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .article-meta {
            font-size: 12px;
            color: var(--text-sec);
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ================== é˜…è¯»å™¨å¸ƒå±€ (å“åº”å¼) ================== */
        .reader-layout {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            /* å…³é”®ï¼šå…è®¸æ¢è¡Œï¼Œå®ç°æ‰‹æœºç«¯ä¸Šä¸‹å †å  */
        }

        .reader-main {
            flex: 2;
            min-width: 300px;
            /* æœ€å°å®½åº¦ */
        }

        .reader-sidebar {
            flex: 1;
            min-width: 280px;
            background: var(--bg);
            /* ä¾§è¾¹æ èå…¥èƒŒæ™¯ */
            border-left: 1px solid var(--border);
            padding-left: 20px;
        }

        @media (max-width: 768px) {
            .reader-sidebar {
                border-left: none;
                padding-left: 0;
                border-top: 1px solid var(--border);
                padding-top: 20px;
            }

            .navbar {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .user-menu {
                width: 100%;
                justify-content: space-between;
            }
        }

        /* é˜…è¯»å†…å®¹æ’ç‰ˆ */
        #read-content {
            font-family: var(--font-serif);
            font-size: 19px;
            line-height: 1.8;
            white-space: pre-wrap;
            color: var(--text-main);
        }

        .highlight {
            background-color: rgba(253, 224, 71, 0.5);
            border-bottom: 2px solid #facc15;
            cursor: pointer;
            transition: background 0.2s;
        }

        .highlight:hover {
            background-color: rgba(253, 224, 71, 0.8);
        }

        /* ç¬”è®°åˆ—è¡¨ */
        .note-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .note-item {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .note-quote {
            font-size: 13px;
            color: var(--text-sec);
            border-left: 3px solid var(--primary);
            padding-left: 8px;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .note-text {
            font-size: 15px;
            font-weight: 500;
        }

        .note-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }

        /* è®¾ç½®é¡µ */
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>

    <div id="auth-container" class="auth-container">
        <div id="view-login" class="card auth-card">
            <div class="auth-title">æ¬¢è¿å›æ¥</div>
            <div class="auth-sub">ç™»å½• Smart Reader ç»§ç»­æ‚¨çš„é˜…è¯»ä¹‹æ—…</div>

            <input type="email" id="login-email" placeholder="name@example.com">
            <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç ">

            <button class="btn" style="width:100%; justify-content:center;" onclick="handleLogin()">ç™»å½•</button>
            <div id="login-msg" style="color:var(--danger); font-size:13px; margin-top:10px; min-height:18px;"></div>

            <div style="margin-top:20px; font-size:14px;">
                è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ <button class="btn btn-text" onclick="switchAuthView('signup')">ç«‹å³æ³¨å†Œ</button>
            </div>
        </div>

        <div id="view-signup" class="card auth-card hidden">
            <div class="auth-title">åˆ›å»ºè´¦å·</div>
            <div class="auth-sub">æ³¨å†Œä¸€ä¸ªæ–°è´¦å·ä»¥å¼€å§‹ä½¿ç”¨</div>

            <input type="email" id="signup-email" placeholder="name@example.com">
            <input type="password" id="signup-password" placeholder="è®¾ç½®å¯†ç  (è‡³å°‘6ä½)">

            <button class="btn" style="width:100%; justify-content:center;" onclick="handleSignup()">æ³¨å†Œ</button>
            <div id="signup-msg" style="color:var(--danger); font-size:13px; margin-top:10px; min-height:18px;"></div>

            <div style="margin-top:20px; font-size:14px;">
                å·²æœ‰è´¦å·ï¼Ÿ <button class="btn btn-text" onclick="switchAuthView('login')">è¿”å›ç™»å½•</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="container hidden">

        <div class="navbar">
            <div class="logo">
                <i class="ph ph-book-open-text"></i> Smart Reader
            </div>
            <div class="user-menu">
                <div class="avatar" id="nav-avatar">U</div>
                <span id="nav-username" style="font-weight:500;">User</span>

                <div style="display:flex; gap:5px;">
                    <button class="btn-icon" title="é¦–é¡µ" onclick="showView('dashboard')"><i class="ph ph-house"
                            style="font-size:20px;"></i></button>
                    <button class="btn-icon" title="è®¾ç½®" onclick="showView('settings')"><i class="ph ph-gear"
                            style="font-size:20px;"></i></button>
                    <button class="btn-icon" title="é€€å‡º" onclick="signOut()"><i class="ph ph-sign-out"
                            style="font-size:20px;"></i></button>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">æˆ‘çš„æ–‡åº“</h2>
                <button class="btn" onclick="openEditor(null)"><i class="ph ph-plus"></i> æ–°å»º/å¯¼å…¥</button>
            </div>
            <div id="article-list" class="article-grid">åŠ è½½ä¸­...</div>
        </div>

        <div id="view-editor" class="hidden card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3><i class="ph ph-pencil-simple"></i> ç¼–è¾‘æ–‡ç« </h3>
                <button class="btn btn-outline" onclick="showView('dashboard')">å–æ¶ˆ</button>
            </div>

            <input type="text" id="edit-title" placeholder="æ–‡ç« æ ‡é¢˜" style="font-size:18px; font-weight:bold;">

            <div
                style="background:var(--bg); padding:15px; border-radius:8px; margin-bottom:15px; border:1px dashed var(--border); display:flex; flex-wrap:wrap; align-items:center; gap:10px;">
                <span style="font-size:14px; font-weight:600;"><i class="ph ph-camera"></i> å›¾ç‰‡è½¬æ–‡å­— (OCR):</span>
                <input type="file" id="ocr-file" accept="image/*" style="width:auto; margin:0; font-size:13px;"
                    onchange="runOCR()">
                <span id="ocr-status" style="font-size:13px; color:var(--primary);"></span>
            </div>

            <textarea id="edit-content" style="min-height:400px; font-family:var(--font-serif);"
                placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..."></textarea>

            <div style="text-align:right;">
                <button class="btn" onclick="saveArticle()"><i class="ph ph-floppy-disk"></i> ä¿å­˜å¹¶é˜…è¯»</button>
            </div>
        </div>

        <div id="view-reader" class="hidden card">
            <div
                style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px;">
                <button class="btn btn-outline btn-sm" onclick="showView('dashboard')"><i class="ph ph-arrow-left"></i>
                    è¿”å›</button>
                <button class="btn btn-outline btn-sm" onclick="switchToEditFromReader()"><i
                        class="ph ph-pencil-simple"></i> ç¼–è¾‘åŸæ–‡</button>
            </div>

            <h1 id="read-title" style="margin-bottom:30px; font-size:28px;"></h1>

            <div class="reader-layout">
                <div class="reader-main">
                    <div id="read-content"></div>
                </div>

                <div class="reader-sidebar">
                    <h4 style="margin-top:0; display:flex; align-items:center; gap:8px;">
                        <i class="ph ph-highlighter"></i> è¯»ä¹¦ç¬”è®°
                    </h4>
                    <p style="font-size:13px; color:var(--text-sec); margin-bottom:20px;">
                        é€‰ä¸­å·¦ä¾§æ–‡å­—å³å¯æ·»åŠ é«˜äº®å’Œç¬”è®°ã€‚
                    </p>
                    <ul id="notes-ul" class="note-list"></ul>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden card" style="max-width:600px; margin:0 auto;">
            <h2 style="border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">è®¾ç½®</h2>

            <div class="settings-section">
                <div class="settings-title">ğŸ¨ å¤–è§‚æ˜¾ç¤º</div>
                <label style="font-size:14px; display:block; margin-bottom:10px;">é¢œè‰²æ¨¡å¼</label>
                <select id="theme-select" onchange="changeTheme(this.value)">
                    <option value="system">ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ</option>
                    <option value="light">â˜€ï¸ æµ…è‰²æ¨¡å¼</option>
                    <option value="dark">ğŸŒ™ æ·±è‰²æ¨¡å¼</option>
                </select>
            </div>

            <div class="settings-section">
                <div class="settings-title">ğŸ‘¤ ä¸ªäººèµ„æ–™</div>
                <label style="font-size:14px;">æ˜µç§°</label>
                <input type="text" id="set-username" placeholder="è®¾ç½®ä¸€ä¸ªæ˜µç§°">
                <button class="btn btn-outline" onclick="updateProfile()">æ›´æ–°èµ„æ–™</button>
            </div>

            <div class="settings-section">
                <div class="settings-title">ğŸ”’ å®‰å…¨ (ä¿®æ”¹å¯†ç )</div>
                <input type="password" id="set-new-password" placeholder="æ–°å¯†ç  (è‡³å°‘6ä½)">
                <button class="btn btn-danger" onclick="updatePassword()">ä¿®æ”¹å¯†ç </button>
            </div>
        </div>

    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rdGd4ZXVrbGxnZ2xoYXJrdXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzI1MTAsImV4cCI6MjA4MDY0ODUxMH0.R-XORb7qYMZPGLj4ZdPt3bIrI61TgOs7vCyxwGmnCpg'

        const db = supabase.createClient(supabaseUrl, supabaseKey)

        let currentUser = null;
        let currentArticleId = null;

        // ================= å¯åŠ¨é€»è¾‘ & ä¸»é¢˜ =================
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'system';
            document.getElementById('theme-select').value = savedTheme;
            changeTheme(savedTheme);
        }

        function changeTheme(mode) {
            localStorage.setItem('theme', mode);
            const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

            if (isDark) document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
        }

        async function init() {
            initTheme();
            const { data: { session } } = await db.auth.getSession();
            updateUserState(session?.user);

            db.auth.onAuthStateChange((_event, session) => updateUserState(session?.user));
        }

        function updateUserState(user) {
            currentUser = user;
            if (user) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                // æ›´æ–°å¯¼èˆªæ ä¿¡æ¯
                const name = user.user_metadata?.display_name || user.email.split('@')[0];
                document.getElementById('nav-username').innerText = name;
                document.getElementById('nav-avatar').innerText = name.charAt(0).toUpperCase();

                // å¡«å……è®¾ç½®é¡µ
                document.getElementById('set-username').value = user.user_metadata?.display_name || '';

                if (!document.getElementById('view-editor').classList.contains('hidden') && !document.getElementById('view-reader').classList.contains('hidden')) {
                    showView('dashboard');
                } else if (document.querySelectorAll('.hidden').length >= 4) {
                    showView('dashboard'); // é»˜è®¤è¿›é¦–é¡µ
                }
            } else {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('auth-container').classList.remove('hidden');
                switchAuthView('login');
            }
        }

        // ================= è§†å›¾æ§åˆ¶ =================
        function showView(name) {
            ['dashboard', 'editor', 'reader', 'settings'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
            });
            document.getElementById('view-' + name).classList.remove('hidden');

            if (name === 'dashboard') loadArticles();
        }

        function switchAuthView(type) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-signup').classList.add('hidden');
            document.getElementById('view-' + type).classList.remove('hidden');
            document.getElementById('login-msg').innerText = '';
            document.getElementById('signup-msg').innerText = '';
        }

        // ================= è®¤è¯é€»è¾‘ =================
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const msg = document.getElementById('login-msg');
            msg.innerText = 'æ­£åœ¨ç™»å½•...';

            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) msg.innerText = error.message;
        }

        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const msg = document.getElementById('signup-msg');
            msg.innerText = 'æ­£åœ¨æ³¨å†Œ...';

            const { error } = await db.auth.signUp({ email, password });
            if (error) msg.innerText = error.message;
            else msg.innerText = 'âœ… æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ã€‚';
        }

        async function signOut() {
            await db.auth.signOut();
            location.reload();
        }

        // ================= è®¾ç½®é€»è¾‘ (æ–°åŠŸèƒ½) =================
        async function updateProfile() {
            const name = document.getElementById('set-username').value;
            const { error } = await db.auth.updateUser({
                data: { display_name: name }
            });
            if (error) alert('æ›´æ–°å¤±è´¥: ' + error.message);
            else {
                alert('èµ„æ–™å·²æ›´æ–°');
                updateUserState(currentUser); // åˆ·æ–°ç•Œé¢
            }
        }

        async function updatePassword() {
            const password = document.getElementById('set-new-password').value;
            if (password.length < 6) return alert('å¯†ç å¤ªçŸ­');
            const { error } = await db.auth.updateUser({ password: password });
            if (error) alert('ä¿®æ”¹å¤±è´¥: ' + error.message);
            else {
                alert('å¯†ç ä¿®æ”¹æˆåŠŸ');
                document.getElementById('set-new-password').value = '';
            }
        }

        // ================= æ–‡ç« ç®¡ç† =================
        async function loadArticles() {
            const list = document.getElementById('article-list');
            list.innerHTML = '<p style="color:var(--text-sec)">åŠ è½½ä¸­...</p>';
            const { data, error } = await db.from('articles').select('*').order('created_at', { ascending: false });

            if (error) return list.innerText = 'Error';
            if (!data.length) return list.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sec);">ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»ºæ–‡ç« </div>';

            list.innerHTML = data.map(a => `
                <div class="card article-card" onclick="openReader('${a.id}')">
                    <div>
                        <h3 style="margin:0 0 10px 0; font-size:18px;">${a.title || 'æ— æ ‡é¢˜'}</h3>
                        <div style="font-size:14px; color:var(--text-sec); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                            ${a.content.slice(0, 100)}...
                        </div>
                    </div>
                    <div class="article-meta">
                        <span>${new Date(a.created_at).toLocaleDateString()}</span>
                        <div onclick="event.stopPropagation()">
                            <button class="btn-icon" title="ç¼–è¾‘" onclick="openEditor('${a.id}')"><i class="ph ph-pencil-simple"></i></button>
                            <button class="btn-icon" title="åˆ é™¤" style="color:var(--danger)" onclick="deleteArticle('${a.id}')"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æŒ‚è½½åˆ° window ç¡®ä¿ onclick èƒ½æ‰¾åˆ° (ä¿®å¤ bug)
        window.deleteArticle = async function (id) {
            if (!confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) return;
            await db.from('articles').delete().eq('id', id);
            loadArticles();
        }

        window.openEditor = async function (id) {
            showView('editor');
            if (id) {
                const { data } = await db.from('articles').select('*').eq('id', id).single();
                currentArticleId = data.id;
                document.getElementById('edit-title').value = data.title;
                document.getElementById('edit-content').value = data.content;
            } else {
                currentArticleId = null;
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-content').value = '';
                document.getElementById('ocr-file').value = '';
                document.getElementById('ocr-status').innerText = '';
            }
        }

        window.switchToEditFromReader = function () {
            if (currentArticleId) openEditor(currentArticleId);
        }

        window.saveArticle = async function () {
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;
            if (!title || !content) return alert('è¯·å¡«å†™å®Œæ•´');

            const payload = { title, content, user_id: currentUser.id };

            if (currentArticleId) {
                await db.from('articles').update(payload).eq('id', currentArticleId);
            } else {
                const res = await db.from('articles').insert(payload).select();
                if (res.data) currentArticleId = res.data[0].id;
            }
            openReader(currentArticleId);
        }

        window.runOCR = function () {
            const file = document.getElementById('ocr-file').files[0];
            if (!file) return;
            const status = document.getElementById('ocr-status');
            status.innerText = 'æ­£åœ¨è¯†åˆ«...';

            Tesseract.recognize(file, 'eng+chi_sim').then(({ data: { text } }) => {
                const ta = document.getElementById('edit-content');
                ta.value += (ta.value ? '\n' : '') + text;
                status.innerText = 'è¯†åˆ«å®Œæˆ';
            });
        }

        // ================= é˜…è¯»ä¸ç¬”è®°æ ¸å¿ƒ (ä¿®å¤ Bug) =================
        window.openReader = async function (id) {
            currentArticleId = id;
            showView('reader');
            const { data } = await db.from('articles').select('*').eq('id', id).single();
            document.getElementById('read-title').innerText = data.title;
            // å­˜å‚¨çº¯æ–‡æœ¬ä»¥ä¾¿åç»­æ¸²æŸ“
            document.getElementById('read-content').dataset.raw = data.content;
            loadAnnotations(id);
        }

        async function loadAnnotations(articleId) {
            const { data: notes } = await db.from('annotations').select('*').eq('article_id', articleId).order('created_at', { ascending: true });

            const contentDiv = document.getElementById('read-content');
            const listUl = document.getElementById('notes-ul');
            listUl.innerHTML = '';

            // æ¯æ¬¡é‡æ–°æ¸²æŸ“éƒ½åŸºäºåŸå§‹çº¯æ–‡æœ¬
            let html = contentDiv.dataset.raw;

            if (notes && notes.length) {
                notes.forEach(n => {
                    // 1. ç”Ÿæˆä¾§è¾¹æ åˆ—è¡¨
                    listUl.innerHTML += `
                        <li class="note-item">
                            <div class="note-quote">"${n.highlight_text}"</div>
                            <div class="note-text">${n.note}</div>
                            <div class="note-actions">
                                <button class="btn-icon" title="ä¿®æ”¹" onclick="editNote('${n.id}', '${n.note.replace(/'/g, "\\'")}')"><i class="ph ph-pencil-simple"></i></button>
                                <button class="btn-icon" title="åˆ é™¤" style="color:var(--danger)" onclick="deleteNote('${n.id}')"><i class="ph ph-trash"></i></button>
                            </div>
                        </li>
                    `;

                    // 2. ç”Ÿæˆæ­£æ–‡é«˜äº®
                    const safeNote = n.note.replace(/"/g, "&quot;");
                    // ç®€å•é«˜äº®æ›¿æ¢ (ç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨ mark.js)
                    html = html.split(n.highlight_text).join(`<span class="highlight" title="${safeNote}">${n.highlight_text}</span>`);
                });
            } else {
                listUl.innerHTML = '<li style="text-align:center; color:var(--text-sec); padding:20px;">æš‚æ— ç¬”è®°ï¼Œå¿«å»é€‰ä¸­æ–‡å­—è¯•è¯•ï¼</li>';
            }
            contentDiv.innerHTML = html;
        }

        // ä¿®å¤ï¼šå°†æ–¹æ³•æŒ‚è½½åˆ° windowï¼Œç¡®ä¿ onclick èƒ½è°ƒç”¨
        window.deleteNote = async function (id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡ç¬”è®°ï¼Ÿ')) return;
            await db.from('annotations').delete().eq('id', id);
            loadAnnotations(currentArticleId);
        }

        window.editNote = async function (id, oldText) {
            const newText = prompt('ä¿®æ”¹ç¬”è®°:', oldText);
            if (newText && newText !== oldText) {
                await db.from('annotations').update({ note: newText }).eq('id', id);
                loadAnnotations(currentArticleId);
            }
        }

        // åˆ’è¯ç›‘å¬
        document.getElementById('read-content').addEventListener('mouseup', async () => {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (!text) return;

            // ç®€å•çš„é˜²æŠ–
            setTimeout(async () => {
                const note = prompt(`ä¸º "${text}" æ·»åŠ ç¬”è®°:`);
                if (note) {
                    await db.from('annotations').insert({
                        article_id: currentArticleId,
                        highlight_text: text,
                        note: note
                    });
                    loadAnnotations(currentArticleId);
                }
                selection.removeAllRanges();
            }, 10);
        });

        // å¯åŠ¨
        init();
    </script>
</body>

</html>