<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Reader Pro</title>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ================== CSS 变量与主题 ================== */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
            --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
            --font-serif: 'Georgia', 'Times New Roman', serif;
        }

        [data-theme="dark"] {
            --primary: #3b82f6;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-sec: #94a3b8;
            --border: #334155;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            height: 100vh;
        }

        .hidden {
            display: none !important;
        }

        input,
        select {
            outline: none;
            transition: all 0.2s;
        }

        /* ================== 登录页 (Split Layout) ================== */
        .auth-wrapper {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: var(--card-bg);
            overflow: hidden;
        }

        /* 左侧风景图 */
        .auth-banner {
            flex: 1;
            background-color: #333;
            background-image: url('https://picsum.photos/1920/1080?grayscale');
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .auth-banner::after {
            content: '点击更换风景';
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .auth-banner:active {
            opacity: 0.8;
        }

        /* 右侧登录框 */
        .auth-side {
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
            background: var(--card-bg);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* 移动端适配 */
        @media (max-width: 768px) {
            .auth-banner {
                display: none;
            }

            .auth-side {
                max-width: 100%;
                box-shadow: none;
            }
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .form-input {
            width: 100%;
            height: 44px;
            padding: 0 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text-main);
            box-sizing: border-box;
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* 验证码与选项 */
        .captcha-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #captcha-canvas {
            background: #eee;
            border-radius: 6px;
            cursor: pointer;
            height: 44px;
            width: 120px;
        }

        .auth-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin-bottom: 24px;
            color: var(--text-sec);
        }

        .auth-options label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        /* 按钮 */
        .btn {
            height: 44px;
            width: 100%;
            border: none;
            border-radius: 6px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            width: auto;
            padding: 0 16px;
            height: 36px;
            font-size: 13px;
        }

        .btn-text {
            background: none;
            color: var(--primary);
            padding: 0;
            width: auto;
            height: auto;
            display: inline;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-icon {
            background: transparent;
            border: none;
            padding: 8px;
            font-size: 20px;
            color: var(--text-sec);
            cursor: pointer;
            border-radius: 4px;
            width: auto;
            height: auto;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--text-main);
        }

        /* ================== 主界面布局 (Dashboard) ================== */
        .app-layout {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .logo {
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border);
            background: #eee;
        }

        /* 文章网格 - 优化排版 */
        .article-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .article-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -8px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .article-card h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            line-height: 1.4;
            color: var(--text-main);
        }

        .article-preview {
            font-size: 14px;
            color: var(--text-sec);
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
        }

        .article-footer {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-sec);
        }

        /* ================== 编辑器 & 阅读器 ================== */
        .editor-container,
        .reader-container,
        .settings-container {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 30px;
            box-shadow: var(--shadow);
        }

        /* 智能导入区 */
        .import-box {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }

        .import-box:hover {
            border-color: var(--primary);
        }

        /* 智能 Textarea */
        #edit-content {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            box-sizing: border-box;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text-main);
            font-size: 17px;
            line-height: 1.8;
            font-family: var(--font-serif);
            resize: none;
            overflow-y: hidden;
            outline: none;
        }

        /* 阅读布局 */
        .reader-layout {
            display: flex;
            gap: 40px;
        }

        .reader-text {
            flex: 2;
            font-family: var(--font-serif);
            font-size: 20px;
            line-height: 2;
            white-space: pre-wrap;
            color: var(--text-main);
        }

        .reader-notes {
            flex: 1;
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            height: fit-content;
            min-width: 280px;
            top: 20px;
            position: sticky;
        }

        .highlight {
            background: rgba(253, 224, 71, 0.4);
            border-bottom: 2px solid #facc15;
            cursor: pointer;
        }

        /* 消息提示 */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>

<body>

    <div id="toast"></div>

    <div id="view-auth" class="auth-wrapper">
        <div class="auth-banner" id="banner-img" onclick="refreshBanner()"></div>

        <div class="auth-side">
            <h2 id="auth-title" style="margin-top:0; font-size:28px;">欢迎回来</h2>
            <p style="color:var(--text-sec); margin-bottom:30px;">请登录您的 Smart Reader 账号</p>

            <div class="form-group">
                <label class="form-label">电子邮箱</label>
                <input type="email" id="auth-email" class="form-input" placeholder="name@example.com">
            </div>

            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" id="auth-password" class="form-input" placeholder="••••••">
            </div>

            <div class="form-group">
                <label class="form-label">人机验证</label>
                <div class="captcha-row">
                    <input type="text" id="auth-captcha-input" class="form-input" placeholder="输入右侧字符"
                        style="width: 140px;">
                    <canvas id="captcha-canvas" width="120" height="44" onclick="drawCaptcha()"
                        title="看不清？点击刷新"></canvas>
                </div>
            </div>

            <div class="auth-options">
                <label>
                    <input type="checkbox" id="remember-me"> 14天内自动登录
                </label>
                <span id="auth-toggle-text">没有账号？<button class="btn-text" onclick="toggleAuthMode()">去注册</button></span>
            </div>

            <button class="btn" onclick="handleAuth()" id="auth-btn">立即登录</button>
            <div id="auth-msg" style="color:var(--danger); font-size:13px; margin-top:15px; min-height:20px;"></div>
        </div>
    </div>

    <div id="view-app" class="hidden app-layout">

        <div class="navbar">
            <div class="logo">
                <i class="ph ph-book-open-text" style="font-size:24px; color:var(--primary)"></i> Smart Reader
            </div>
            <div class="user-panel">
                <img id="nav-avatar" class="avatar" src="">
                <button class="btn-icon" onclick="showDashboard()" title="主页"><i class="ph ph-house"></i></button>
                <button class="btn-icon" onclick="showSettings()" title="设置"><i class="ph ph-gear"></i></button>
                <button class="btn-icon" onclick="signOut()" title="退出"><i class="ph ph-sign-out"></i></button>
            </div>
        </div>

        <div id="page-dashboard" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>我的文库</h2>
                <button class="btn" style="width:auto" onclick="openEditor(null)"><i class="ph ph-plus"></i>
                    新建文章</button>
            </div>
            <div id="article-list" class="article-grid"></div>
        </div>

        <div id="page-editor" class="hidden editor-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3><i class="ph ph-pencil-simple"></i> 编辑模式</h3>
                <button class="btn-outline" onclick="showDashboard()">取消</button>
            </div>

            <input type="text" id="edit-title" class="form-input" placeholder="请输入文章标题"
                style="font-size:18px; font-weight:bold; height:50px;">

            <div class="import-box">
                <i class="ph ph-file-text" style="font-size:32px; color:var(--text-sec)"></i>
                <p style="margin:5px 0; font-size:14px; color:var(--text-sec)">将 .txt 或 .md 文件拖入或点击导入 (瞬间完成)</p>
                <input type="file" id="file-import" accept=".txt,.md" style="display:none"
                    onchange="handleFileImport(this)">
                <button class="btn-outline" onclick="document.getElementById('file-import').click()">选择本地文件</button>
            </div>

            <textarea id="edit-content" placeholder="在此输入内容..."></textarea>

            <div style="text-align:right; margin-top:20px;">
                <button class="btn" style="width:auto; display:inline-flex;" onclick="saveArticle()"><i
                        class="ph ph-floppy-disk"></i> 保存并阅读</button>
            </div>
        </div>

        <div id="page-reader" class="hidden reader-container">
            <div
                style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">
                <button class="btn-outline" onclick="showDashboard()"><i class="ph ph-arrow-left"></i> 返回</button>
                <button class="btn-outline" onclick="switchToEdit()"><i class="ph ph-pencil-simple"></i> 编辑</button>
            </div>

            <h1 id="read-title" style="margin-bottom:30px; font-size:32px;"></h1>

            <div class="reader-layout">
                <div id="read-content" class="reader-text"></div>

                <div class="reader-notes">
                    <h4 style="margin-top:0; display:flex; align-items:center; gap:8px;">
                        <i class="ph ph-highlighter"></i> 笔记
                    </h4>
                    <p style="font-size:12px; color:var(--text-sec)">选中左侧文字添加高亮</p>
                    <div id="notes-list" style="margin-top:15px;"></div>
                </div>
            </div>
        </div>

        <div id="page-settings" class="hidden settings-container" style="max-width:600px; margin:0 auto;">
            <h2 style="border-bottom:1px solid var(--border); padding-bottom:15px;">设置</h2>

            <div class="form-group">
                <label class="form-label">外观模式</label>
                <select id="theme-select" class="form-input" onchange="changeTheme(this.value)">
                    <option value="system">跟随系统</option>
                    <option value="light">浅色模式</option>
                    <option value="dark">深色模式</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">更换头像 (本地上传)</label>
                <div style="display:flex; align-items:center; gap:20px;">
                    <img id="setting-avatar" class="avatar" style="width:64px; height:64px;">
                    <div>
                        <input type="file" id="avatar-upload" accept="image/*" style="display:none"
                            onchange="uploadAvatar(this)">
                        <button class="btn-outline"
                            onclick="document.getElementById('avatar-upload').click()">选择图片...</button>
                        <div style="font-size:12px; color:var(--text-sec); margin-top:5px;">支持 jpg, png, webp</div>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-top:40px;">
                <label class="form-label">安全</label>
                <button class="btn-danger" style="width:auto; padding:0 20px;" onclick="updatePassword()">修改密码</button>
            </div>
        </div>
    </div>

    <script>
        // ================= 配置区 =================
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rdGd4ZXVrbGxnZ2xoYXJrdXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzI1MTAsImV4cCI6MjA4MDY0ODUxMH0.R-XORb7qYMZPGLj4ZdPt3bIrI61TgOs7vCyxwGmnCpg'

        const db = supabase.createClient(supabaseUrl, supabaseKey)

        let currentUser = null;
        let currentArticleId = null;
        let isSignupMode = false;
        let generatedCaptcha = '';

        // ================= 初始化逻辑 =================
        async function init() {
            // 1. 恢复主题
            const theme = localStorage.getItem('theme') || 'system';
            document.getElementById('theme-select').value = theme;
            changeTheme(theme);

            // 2. 刷新背景图 & 验证码
            refreshBanner();
            drawCaptcha();

            // 3. 检查会话 (Session)
            // 逻辑：如果之前没勾选“14天免登录”，且这是新开窗口，则认为过期
            const isRemembered = localStorage.getItem('remember_me') === 'true';

            // 监听窗口关闭事件
            window.addEventListener('beforeunload', () => {
                if (!localStorage.getItem('remember_me')) {
                    // 如果没勾选记住我，这里其实不需要手动调 signOut，
                    // 因为下次进来我们只认 localStorage 里的持久化 token。
                    // 但为了安全，我们可以清除本地会话缓存（视Supabase实现而定）。
                }
            });

            // 获取用户
            const { data: { session } } = await db.auth.getSession();

            // 关键：如果session存在，但用户之前没有勾选记住我，且这是一次全新的浏览器进程？
            // Supabase 默认 persistence 是 local，所以 token 会一直存在。
            // 我们手动模拟 "Session Only" 效果：在登录时如果不勾选记住我，
            // 实际上我们很难阻止 Supabase 写入 LocalStorage。
            // 变通方案：登录时写入一个 'session_active' 到 sessionStorage。
            // 每次 init 检查：如果 session 存在，但 sessionStorage 里没有 flag，且 localStorage 也没有 remember_me
            // 说明用户关闭过浏览器，强制登出。

            if (session) {
                const isSessionValid = sessionStorage.getItem('session_active');
                if (!isRemembered && !isSessionValid) {
                    await db.auth.signOut(); // 强制登出
                    currentUser = null;
                    showAuth();
                } else {
                    sessionStorage.setItem('session_active', 'true'); // 标记本次活跃
                    updateUserState(session.user);
                }
            } else {
                showAuth();
            }

            // 监听 Textarea 自适应
            const tx = document.getElementById('edit-content');
            tx.addEventListener("input", function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // ================= UI 切换 =================
        function showAuth() {
            document.getElementById('view-auth').classList.remove('hidden');
            document.getElementById('view-app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
        }

        function showDashboard() {
            hidePages();
            document.getElementById('page-dashboard').classList.remove('hidden');
            loadArticles();
        }

        function showSettings() {
            hidePages();
            document.getElementById('page-settings').classList.remove('hidden');
            // 预览头像
            const avatar = getAvatarUrl(currentUser);
            document.getElementById('setting-avatar').src = avatar;
        }

        function hidePages() {
            ['dashboard', 'editor', 'reader', 'settings'].forEach(p => {
                document.getElementById('page-' + p).classList.add('hidden');
            });
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function refreshBanner() {
            // 使用 Picsum 获取随机风景，加时间戳防缓存
            const url = `https://picsum.photos/1920/1080?grayscale&blur=2&random=${Date.now()}`;
            const banner = document.getElementById('banner-img');
            banner.style.opacity = 0;
            setTimeout(() => {
                banner.style.backgroundImage = `url('${url}')`;
                banner.style.opacity = 1;
            }, 300);
        }

        // ================= 验证码逻辑 (Canvas) =================
        function drawCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 生成随机字符
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            generatedCaptcha = code;

            // 绘制背景干扰
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 绘制文字
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = '#333';
            ctx.textBaseline = 'middle';
            ctx.textAlign = 'center';

            // 简单的扭曲效果
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate((Math.random() - 0.5) * 0.4);
            ctx.fillText(code, 0, 0);
            ctx.restore();

            // 绘制干扰线
            for (let i = 0; i < 5; i++) {
                ctx.strokeStyle = '#ccc';
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.stroke();
            }
        }

        // ================= 认证系统 =================
        function toggleAuthMode() {
            isSignupMode = !isSignupMode;
            document.getElementById('auth-title').innerText = isSignupMode ? '创建新账号' : '欢迎回来';
            document.getElementById('auth-btn').innerText = isSignupMode ? '立即注册' : '立即登录';
            document.getElementById('auth-toggle-text').innerHTML = isSignupMode ?
                `已有账号？<button class="btn-text" onclick="toggleAuthMode()">去登录</button>` :
                `没有账号？<button class="btn-text" onclick="toggleAuthMode()">去注册</button>`;
            drawCaptcha(); // 切换时刷新验证码
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const captchaInput = document.getElementById('auth-captcha-input').value.toUpperCase();
            const rememberMe = document.getElementById('remember-me').checked;
            const msg = document.getElementById('auth-msg');

            // 1. 验证
            if (!email || !password) return msg.innerText = "请填写完整信息";
            if (captchaInput !== generatedCaptcha) {
                drawCaptcha();
                return msg.innerText = "验证码错误，请重试";
            }

            msg.innerText = "处理中...";

            // 2. Supabase 交互
            let result;
            if (isSignupMode) {
                result = await db.auth.signUp({ email, password });
            } else {
                result = await db.auth.signInWithPassword({ email, password });
            }

            // 3. 结果处理
            if (result.error) {
                msg.innerText = result.error.message;
                drawCaptcha();
            } else {
                if (isSignupMode && !result.data.session) {
                    msg.innerText = "注册成功！请直接登录";
                    toggleAuthMode();
                } else {
                    // 登录成功
                    if (rememberMe) {
                        localStorage.setItem('remember_me', 'true');
                    } else {
                        localStorage.removeItem('remember_me');
                    }
                    sessionStorage.setItem('session_active', 'true');
                    updateUserState(result.data.user);
                }
            }
        }

        function updateUserState(user) {
            currentUser = user;
            if (user) {
                showApp();
                showDashboard();
                // 设置头像
                document.getElementById('nav-avatar').src = getAvatarUrl(user);
            }
        }

        async function signOut() {
            await db.auth.signOut();
            localStorage.removeItem('remember_me');
            sessionStorage.removeItem('session_active');
            location.reload();
        }

        // ================= 智能文件导入 (OCR替代方案) =================
        function handleFileImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                const tx = document.getElementById('edit-content');

                // 填充标题（文件名去除后缀）
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                if (!document.getElementById('edit-title').value) {
                    document.getElementById('edit-title').value = fileName;
                }

                tx.value = text;
                tx.style.height = 'auto';
                tx.style.height = (tx.scrollHeight) + 'px';
                toast('文件导入成功！');
            };
            reader.readAsText(file);
            input.value = ''; // 重置
        }

        // ================= 头像上传 (Storage) =================
        function getAvatarUrl(user) {
            if (user?.user_metadata?.avatar_url) return user.user_metadata.avatar_url;
            return `https://api.dicebear.com/7.x/identicon/svg?seed=${user.id}`; // 默认头像
        }

        async function uploadAvatar(input) {
            const file = input.files[0];
            if (!file) return;

            toast('正在上传头像...');

            try {
                // 1. 上传文件到 'avatars' bucket
                // 文件名: userId/timestamp.ext
                const fileExt = file.name.split('.').pop();
                const filePath = `${currentUser.id}/${Date.now()}.${fileExt}`;

                const { error: uploadError } = await db.storage
                    .from('avatars')
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                // 2. 获取公开链接
                const { data: { publicUrl } } = db.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                // 3. 更新用户 Metadata
                const { error: updateError } = await db.auth.updateUser({
                    data: { avatar_url: publicUrl }
                });

                if (updateError) throw updateError;

                // 4. UI 刷新
                toast('头像更新成功！');
                document.getElementById('nav-avatar').src = publicUrl;
                document.getElementById('setting-avatar').src = publicUrl;

            } catch (error) {
                console.error(error);
                toast('上传失败: 请确保在后台创建了 Public Bucket "avatars"');
            }
        }

        // ================= 文章 CRUD =================
        async function loadArticles() {
            const list = document.getElementById('article-list');
            list.innerHTML = '加载中...';
            const { data, error } = await db.from('articles').select('*').order('created_at', { ascending: false });

            if (!data || data.length === 0) {
                list.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:var(--text-sec); padding:40px; border:2px dashed var(--border); border-radius:12px;">暂无文章，点击右上角新建</div>`;
                return;
            }

            list.innerHTML = data.map(a => `
                <div class="article-card" onclick="openReader('${a.id}')">
                    <div>
                        <h3>${a.title || '未命名'}</h3>
                        <div class="article-preview">${a.content}</div>
                    </div>
                    <div class="article-footer">
                        <span>${new Date(a.created_at).toLocaleDateString()}</span>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteArticle('${a.id}')"><i class="ph ph-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function saveArticle() {
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;
            if (!title || !content) return toast('请填写标题和内容');

            const payload = { title, content, user_id: currentUser.id };

            if (currentArticleId) {
                await db.from('articles').update(payload).eq('id', currentArticleId);
            } else {
                const res = await db.from('articles').insert(payload).select();
                if (res.data) currentArticleId = res.data[0].id;
            }
            openReader(currentArticleId);
        }

        async function deleteArticle(id) {
            if (confirm('删除此文章？')) {
                await db.from('articles').delete().eq('id', id);
                loadArticles();
            }
        }

        // ================= 阅读与笔记 =================
        function openEditor(id) {
            hidePages();
            document.getElementById('page-editor').classList.remove('hidden');
            const tx = document.getElementById('edit-content');
            tx.style.height = '400px';

            if (id) {
                // 编辑现有 (略，复用 logic)
            } else {
                currentArticleId = null;
                document.getElementById('edit-title').value = '';
                tx.value = '';
            }
        }

        function switchToEdit() {
            if (currentArticleId) {
                hidePages();
                document.getElementById('page-editor').classList.remove('hidden');
                // 重新拉取最新数据
                db.from('articles').select('*').eq('id', currentArticleId).single().then(({ data }) => {
                    document.getElementById('edit-title').value = data.title;
                    const tx = document.getElementById('edit-content');
                    tx.value = data.content;
                    tx.style.height = tx.scrollHeight + 'px';
                });
            }
        }

        async function openReader(id) {
            currentArticleId = id;
            hidePages();
            document.getElementById('page-reader').classList.remove('hidden');

            const { data } = await db.from('articles').select('*').eq('id', id).single();
            document.getElementById('read-title').innerText = data.title;
            const contentDiv = document.getElementById('read-content');
            contentDiv.dataset.raw = data.content; // 存原始内容
            loadAnnotations(id);
        }

        async function loadAnnotations(articleId) {
            const { data: notes } = await db.from('annotations').select('*').eq('article_id', articleId).order('created_at', { ascending: true });
            const contentDiv = document.getElementById('read-content');
            const notesList = document.getElementById('notes-list');

            notesList.innerHTML = '';
            let html = contentDiv.dataset.raw;

            if (notes && notes.length) {
                notes.forEach(n => {
                    // 渲染高亮
                    const safeNote = n.note.replace(/"/g, "&quot;");
                    html = html.split(n.highlight_text).join(`<span class="highlight" title="${safeNote}">${n.highlight_text}</span>`);

                    // 渲染侧边栏
                    notesList.innerHTML += `
                        <div style="background:var(--card-bg); border:1px solid var(--border); padding:10px; border-radius:8px; margin-bottom:10px; font-size:13px;">
                            <div style="border-left:3px solid var(--primary); padding-left:8px; color:var(--text-sec); margin-bottom:5px;">"${n.highlight_text}"</div>
                            <div>${n.note}</div>
                            <div style="text-align:right; margin-top:5px;"><button class="btn-text" style="color:var(--danger); font-size:12px;" onclick="deleteNote('${n.id}')">删除</button></div>
                        </div>
                    `;
                });
            } else {
                notesList.innerHTML = '<div style="color:var(--text-sec); text-align:center;">暂无笔记</div>';
            }
            contentDiv.innerHTML = html;
        }

        async function deleteNote(id) {
            if (confirm('删除笔记？')) {
                await db.from('annotations').delete().eq('id', id);
                loadAnnotations(currentArticleId);
            }
        }

        // 划词高亮
        document.getElementById('read-content').addEventListener('mouseup', () => {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            if (!text) return;

            setTimeout(async () => {
                const note = prompt('添加笔记:');
                if (note) {
                    await db.from('annotations').insert({ article_id: currentArticleId, highlight_text: text, note: note });
                    loadAnnotations(currentArticleId);
                }
                sel.removeAllRanges();
            }, 10);
        });

        // 辅助
        function changeTheme(mode) {
            localStorage.setItem('theme', mode);
            const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
        }

        async function updatePassword() {
            const p = prompt("请输入新密码 (至少6位)");
            if (p && p.length >= 6) {
                const { error } = await db.auth.updateUser({ password: p });
                if (error) toast(error.message); else toast('密码修改成功');
            } else if (p) {
                toast('密码太短');
            }
        }

        // 启动
        init();
    </script>
</body>

</html>