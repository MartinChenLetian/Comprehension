<!-- <!DOCTYPE html>
<html>

<head>
    <title>æˆ‘çš„ Supabase ç½‘ç«™</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>

<body>
    <h1>ç•™è¨€æ¿</h1>
    <input type="text" id="msgInput" placeholder="è¾“å…¥ç•™è¨€...">
    <button onclick="addMessage()">å‘é€</button>
    <ul id="msgList"></ul>

    <script>
        // 2. åˆå§‹åŒ– Supabase
        // æŠŠä¸‹é¢æ¢æˆä½ ç¬¬ä¸€æ­¥é‡Œè®°ä¸‹çš„ URL å’Œ Key
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rdGd4ZXVrbGxnZ2xoYXJrdXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzI1MTAsImV4cCI6MjA4MDY0ODUxMH0.R-XORb7qYMZPGLj4ZdPt3bIrI61TgOs7vCyxwGmnCpg'
        const supabase_db = supabase.createClient(supabaseUrl, supabaseKey) -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Smart Reader</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        .btn {
            padding: 8px 16px;
            cursor: pointer;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .btn:hover {
            background: #555;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #333;
            color: #333;
        }

        /* å¸ƒå±€ */
        #auth-section,
        #dashboard,
        #editor-section,
        #reader-section {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
        }

        /* åˆ—è¡¨æ ·å¼ */
        .article-card {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* é«˜äº®æ ·å¼ */
        .highlight {
            background-color: #ffeb3b;
            cursor: pointer;
            border-bottom: 2px solid #fbc02d;
        }

        /* OCR åŠ è½½æ¡ */
        #ocr-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <h1>ğŸ“š My Smart Reader</h1>

    <div id="auth-section">
        <h3>è¯·å…ˆç™»å½•</h3>
        <input type="email" id="email" placeholder="é‚®ç®±" style="padding: 8px;">
        <input type="password" id="password" placeholder="å¯†ç " style="padding: 8px;">
        <br><br>
        <button class="btn" onclick="signUp()">æ³¨å†Œ</button>
        <button class="btn btn-outline" onclick="signIn()">ç™»å½•</button>
        <p id="auth-msg" style="color: red;"></p>
    </div>

    <div id="dashboard" class="hidden">
        <div style="display:flex; justify-content:space-between;">
            <h3>æˆ‘çš„æ–‡ç« åº“</h3>
            <button class="btn" onclick="showEditor()">+ æ–°å»ºå¯¼å…¥</button>
        </div>
        <div id="article-list">åŠ è½½ä¸­...</div>
        <br>
        <button class="btn btn-outline" onclick="signOut()">é€€å‡ºç™»å½•</button>
    </div>

    <div id="editor-section" class="hidden">
        <h3>âœï¸ ç¼–è¾‘/å¯¼å…¥æ–‡ç« </h3>
        <input type="text" id="edit-title" placeholder="æ–‡ç« æ ‡é¢˜" style="width: 100%; margin-bottom: 10px; padding: 5px;">

        <div style="background: #f9f9f9; padding: 10px; margin-bottom: 10px;">
            <label>ğŸ“· å›¾ç‰‡è½¬æ–‡å­— (OCR): </label>
            <input type="file" id="ocr-file" accept="image/*" onchange="runOCR()">
            <div id="ocr-status"></div>
        </div>

        <textarea id="edit-content" rows="15" style="width: 100%; padding: 10px;" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´å†…å®¹..."></textarea>
        <br><br>
        <button class="btn" onclick="saveArticle(false)">ä¿å­˜è‰ç¨¿</button>
        <button class="btn" style="background: green;" onclick="saveArticle(true)">å®Œæˆå¹¶é”å®š (å»é˜…è¯»)</button>
        <button class="btn btn-outline" onclick="showDashboard()">å–æ¶ˆ</button>
    </div>

    <div id="reader-section" class="hidden">
        <button class="btn btn-outline" onclick="showDashboard()">â† è¿”å›åˆ—è¡¨</button>
        <h2 id="read-title"></h2>
        <p style="color: #666; font-size: 0.8em;">ğŸ’¡ é€‰ä¸­æ–‡å­—å³å¯æ·»åŠ ç¬”è®°</p>
        <div id="read-content" style="white-space: pre-wrap;"></div>

        <div id="annotations-list" style="margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 10px;">
            <h4>ğŸ“ ç¬”è®°åˆ—è¡¨</h4>
            <ul id="notes-ul"></ul>
        </div>
    </div>

    <script>
        // ================= é…ç½®åŒº =================
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rdGd4ZXVrbGxnZ2xoYXJrdXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzI1MTAsImV4cCI6MjA4MDY0ODUxMH0.R-XORb7qYMZPGLj4ZdPt3bIrI61TgOs7vCyxwGmnCpg'
        const db = supabase.createClient(supabaseUrl, supabaseKey)

        let currentUser = null;
        let currentArticleId = null;

        // ================= èº«ä»½éªŒè¯é€»è¾‘ =================
        async function checkUser() {
            const { data: { user } } = await db.auth.getUser()
            currentUser = user;
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                showDashboard();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
        }

        async function signUp() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await db.auth.signUp({ email, password });
            if (error) alert(error.message);
            else alert('æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±éªŒè¯æˆ–ç›´æ¥ç™»å½•ï¼ˆè§†Supabaseè®¾ç½®è€Œå®šï¼‰');
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await db.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else checkUser();
        }

        async function signOut() {
            await db.auth.signOut();
            location.reload();
        }

        // ================= é¡µé¢åˆ‡æ¢é€»è¾‘ =================
        function hideAll() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('editor-section').classList.add('hidden');
            document.getElementById('reader-section').classList.add('hidden');
        }

        function showDashboard() {
            hideAll();
            document.getElementById('dashboard').classList.remove('hidden');
            loadArticles();
        }

        function showEditor(article = null) {
            hideAll();
            document.getElementById('editor-section').classList.remove('hidden');
            if (article) {
                currentArticleId = article.id;
                document.getElementById('edit-title').value = article.title;
                document.getElementById('edit-content').value = article.content;
            } else {
                currentArticleId = null;
                document.getElementById('edit-title').value = '';
                document.getElementById('edit-content').value = '';
            }
        }

        // ================= æ ¸å¿ƒåŠŸèƒ½ï¼šOCR =================
        function runOCR() {
            const file = document.getElementById('ocr-file').files[0];
            if (!file) return;

            const status = document.getElementById('ocr-status');
            status.innerText = 'æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å...';

            Tesseract.recognize(
                file,
                'eng+chi_sim', // æ”¯æŒè‹±æ–‡å’Œç®€ä½“ä¸­æ–‡
                { logger: m => status.innerText = `è¿›åº¦: ${(m.progress * 100).toFixed(0)}% (${m.status})` }
            ).then(({ data: { text } }) => {
                const textArea = document.getElementById('edit-content');
                textArea.value += '\n' + text; // è¿½åŠ åˆ°ç¼–è¾‘å™¨
                status.innerText = 'âœ… è¯†åˆ«å®Œæˆï¼';
            });
        }

        // ================= æ ¸å¿ƒåŠŸèƒ½ï¼šæ•°æ®åº“æ“ä½œ =================
        async function loadArticles() {
            const list = document.getElementById('article-list');
            list.innerHTML = 'åŠ è½½ä¸­...';
            const { data, error } = await db.from('articles').select('*').order('created_at', { ascending: false });

            if (error) { list.innerText = 'åŠ è½½å¤±è´¥'; return; }

            list.innerHTML = data.map(a => `
                <div class="article-card">
                    <div>
                        <strong>${a.title || 'æ— æ ‡é¢˜'}</strong> 
                        <span style="font-size:0.8em; color:#888;">${a.is_locked ? 'ğŸ”’ ä»…è¯»' : 'âœï¸ è‰ç¨¿'}</span>
                    </div>
                    <button class="btn btn-outline" style="font-size:0.8em" 
                        onclick="${a.is_locked ? `openReader('${a.id}')` : `openEditor('${a.id}')`}">
                        ${a.is_locked ? 'é˜…è¯»' : 'ç¼–è¾‘'}
                    </button>
                </div>
            `).join('');
        }

        async function openEditor(id) {
            const { data } = await db.from('articles').select('*').eq('id', id).single();
            showEditor(data);
        }

        async function saveArticle(lock) {
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;

            const payload = { title, content, is_locked: lock, user_id: currentUser.id };

            let error;
            if (currentArticleId) {
                // æ›´æ–°
                ({ error } = await db.from('articles').update(payload).eq('id', currentArticleId));
            } else {
                // æ–°å»º
                ({ error } = await db.from('articles').insert(payload));
            }

            if (error) alert('ä¿å­˜å¤±è´¥');
            else if (lock) showDashboard(); // å¦‚æœé”å®šäº†ï¼Œå›åˆ—è¡¨
            else alert('è‰ç¨¿å·²ä¿å­˜');
        }

        // ================= æ ¸å¿ƒåŠŸèƒ½ï¼šé˜…è¯»å™¨ä¸é«˜äº® =================
        async function openReader(id) {
            currentArticleId = id;
            hideAll();
            document.getElementById('reader-section').classList.remove('hidden');

            // 1. è·å–æ–‡ç« å†…å®¹
            const { data: article } = await db.from('articles').select('*').eq('id', id).single();
            document.getElementById('read-title').innerText = article.title;
            const contentDiv = document.getElementById('read-content');
            contentDiv.innerText = article.content; // é‡ç½®å†…å®¹

            // 2. è·å–ç¬”è®°å¹¶æ¸²æŸ“é«˜äº®
            loadAnnotations(id);
        }

        async function loadAnnotations(articleId) {
            const { data: notes } = await db.from('annotations').select('*').eq('article_id', articleId);
            const contentDiv = document.getElementById('read-content');
            const originalText = contentDiv.innerText; // è¿™é‡Œçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œç”¨äºæ¼”ç¤º
            const notesUl = document.getElementById('notes-ul');

            notesUl.innerHTML = '';

            // ç®€å•çš„â€œæŸ¥æ‰¾æ›¿æ¢â€é«˜äº®é€»è¾‘ (å®é™…ç”Ÿäº§ä¸­åº”è¯¥ç”¨ range index)
            // è¿™é‡Œä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä½¿ç”¨äº† replaceï¼Œè¿™æœ‰ç¼ºé™·ï¼ˆå¦‚æœæ–‡ä¸­å¤šæ¬¡å‡ºç°ç›¸åŒå¥å­ä¼šåªé«˜äº®ç¬¬ä¸€ä¸ªï¼‰
            // ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ mark.js åº“

            if (notes && notes.length > 0) {
                let html = originalText;
                notes.forEach(n => {
                    // æ·»åŠ åˆ—è¡¨
                    notesUl.innerHTML += `<li><b>"${n.highlight_text}"</b>: ${n.note}</li>`;

                    // é«˜äº®æ–‡æœ¬ (ç®€å•æ›¿æ¢æ³•)
                    html = html.replace(n.highlight_text, `<span class="highlight" title="${n.note}" onclick="alert('ç¬”è®°: ${n.note}')">${n.highlight_text}</span>`);
                });
                contentDiv.innerHTML = html;
            }
        }

        // ç›‘å¬é€‰ä¸­æ–‡æœ¬äº‹ä»¶
        document.getElementById('read-content').addEventListener('mouseup', async () => {
            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text.length > 0) {
                const note = prompt(`ä½ è¦é«˜äº® "${text}"ã€‚\næ·»åŠ ä¸€ç‚¹å¤‡æ³¨å—ï¼Ÿ`);
                if (note !== null) { // å¦‚æœç‚¹å‡»äº†å–æ¶ˆåˆ™ä¸ä¿å­˜
                    const { error } = await db.from('annotations').insert({
                        article_id: currentArticleId,
                        highlight_text: text,
                        note: note || '' // å…è®¸ç©ºå¤‡æ³¨
                    });

                    if (error) alert('ä¿å­˜ç¬”è®°å¤±è´¥');
                    else {
                        loadAnnotations(currentArticleId); // é‡æ–°åŠ è½½é«˜äº®
                    }
                }
                selection.removeAllRanges(); // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            }
        });

        // åˆå§‹åŒ–
        checkUser();
    </script>
</body>

</html>