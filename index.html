<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Reader Pro</title>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/yjs@13.6.15/dist/yjs.js"></script>
    <script src="https://unpkg.com/y-webrtc@10.2.5/dist/y-webrtc.js"></script>
    <script src="https://unpkg.com/y-indexeddb@9.0.10/dist/y-indexeddb.js"></script>
    <link rel="shortcut icon" href="public/icons/icon.png" type="image/x-icon">

    <style>
        /* ================== Design System ================== */
        :root {
            --primary: #0A84FF;
            --bg-body: #E9EEF7;
            --bg-card: rgba(255, 255, 255, 0.62);
            --bg-sidebar: rgba(255, 255, 255, 0.6);
            --text-main: #0F172A;
            --text-sec: #5B6472;
            --separator: rgba(255, 255, 255, 0);
            --shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            --radius: 18px;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            --btn-primary-bg: linear-gradient(135deg, rgba(10, 132, 255, 0.9), rgba(56, 189, 248, 0.9));
            --btn-primary-text: #FFFFFF;
            --btn-primary-shadow: 0 18px 35px rgba(10, 132, 255, 0.35);
            --btn-surface: rgba(255, 255, 255, 0.45);
            --btn-surface-hover: rgba(255, 255, 255, 0.65);
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-strong: rgba(255, 255, 255, 0.8);
            --glass-blur: blur(22px) saturate(180%);
            --auth-surface: rgba(255, 255, 255, 0.35);
            --auth-card: rgba(255, 255, 255, 0.75);
            --auth-input-bg: rgba(255, 255, 255, 0.6);
            --auth-input-focus: rgba(10, 132, 255, 0.2);
            --editor-paper: rgba(255, 255, 255, 0.92);
            --editor-paper-border: rgba(15, 23, 42, 0.08);
            --editor-paper-shadow: 0 24px 60px rgba(15, 23, 42, 0.16);
            --cursor-glow: rgba(56, 189, 248, 0.22);
            --cursor-x: 50%;
            --cursor-y: 18%;
            --cursor-glass: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'><circle cx='14' cy='14' r='6.5' fill='rgba(255,255,255,0.35)' stroke='rgba(255,255,255,0.5)' stroke-width='1.2'/><circle cx='14' cy='14' r='2.5' fill='rgba(10,132,255,0.55)'/></svg>") 14 14, auto;
            color-scheme: light dark;
        }

        [data-theme="dark"] {
            --bg-body: #07080C;
            --bg-card: rgba(15, 16, 20, 0.6);
            --bg-sidebar: rgba(12, 13, 17, 0.72);
            --text-main: #E6EDF7;
            --text-sec: #9AA4B2;
            --separator: rgba(255, 255, 255, 0);
            --btn-primary-bg: linear-gradient(135deg, rgba(56, 189, 248, 0.9), rgba(99, 102, 241, 0.9));
            --btn-primary-shadow: 0 20px 40px rgba(56, 189, 248, 0.28);
            --btn-surface: rgba(255, 255, 255, 0.08);
            --btn-surface-hover: rgba(255, 255, 255, 0.16);
            --glass-bg: rgba(20, 22, 28, 0.55);
            --glass-strong: rgba(24, 26, 32, 0.7);
            --glass-blur: blur(24px) saturate(170%);
            --auth-surface: rgba(12, 14, 18, 0.6);
            --auth-card: rgba(18, 20, 26, 0.75);
            --auth-input-bg: rgba(18, 20, 26, 0.55);
            --auth-input-focus: rgba(56, 189, 248, 0.22);
            --editor-paper: rgba(17, 19, 24, 0.92);
            --editor-paper-border: rgba(148, 163, 184, 0.14);
            --editor-paper-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
            --cursor-glow: rgba(56, 189, 248, 0.16);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            transition: background 0.3s;
            background-image: radial-gradient(600px circle at var(--cursor-x) var(--cursor-y), var(--cursor-glow), transparent 65%),
                radial-gradient(circle at top, rgba(255, 255, 255, 0.6), transparent 45%),
                radial-gradient(circle at 10% 20%, rgba(59, 130, 246, 0.18), transparent 45%),
                radial-gradient(circle at 90% 0%, rgba(56, 189, 248, 0.2), transparent 40%);
            cursor: none;
        }

        html,
        body,
        body * {
            cursor: none !important;
        }

        .hidden {
            display: none !important;
        }

        /* Buttons */
        .btn {
            border: none;
            outline: none;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }

        button {
            border: 0;
            outline: none;
        }

        .btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        .btn-primary {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            border-radius: 14px;
            padding: 10px 24px;
            font-size: 15px;
            box-shadow: var(--btn-primary-shadow);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
        }

        .btn-text {
            background: transparent;
            color: var(--primary);
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 10px;
            border: 0;
        }

        .btn-text.danger {
            color: #FF3B30;
        }

        .btn-back {
            background: transparent;
            color: var(--text-sec);
            font-size: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
        }

        .btn-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--glass-bg);
            color: var(--primary);
            font-size: 22px;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            backdrop-filter: var(--glass-blur);
            border: 0;
        }

        .btn-icon-sm {
            background: transparent;
            padding: 8px;
            border-radius: 10px;
            color: var(--text-sec);
            transition: 0.2s;
            cursor: pointer;
            border: 0;
        }

        .btn-icon-sm:hover {
            background: var(--btn-surface);
            color: var(--text-main);
        }

        .btn-icon-danger {
            background: transparent;
            border: 0;
            color: #FF3B30;
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .btn-icon-danger:hover {
            background: rgba(255, 59, 48, 0.14);
        }

        .btn-text:hover {
            background: var(--btn-surface);
        }

        .input-clean {
            width: 100%;
            padding: 12px;
            background: var(--glass-bg);
            border: none;
            border-radius: 12px;
            color: var(--text-main);
            font-size: 16px;
            transition: 0.2s;
            backdrop-filter: var(--glass-blur);
        }

        .input-clean:focus {
            background: var(--glass-strong);
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.4);
            outline: none;
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: none;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            backdrop-filter: var(--glass-blur);
            box-shadow: inset -1px 0 0 rgba(255, 255, 255, 0.08);
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            position: relative;
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
            border: 1px solid var(--separator);
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 10px;
            color: var(--text-sec);
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
            font-weight: 500;
            transition: 0.2s;
        }

        .nav-item.active {
            background: var(--glass-strong);
            color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            font-weight: 600;
            backdrop-filter: var(--glass-blur);
        }

        /* Dashboard */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            height: 50px;
        }

        .page-title {
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: var(--radius);
            border: none;
            backdrop-filter: var(--glass-blur);
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-sec);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-main);
        }

        .doc-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding-bottom: 100px;
        }

        .doc-item {
            background: var(--glass-bg);
            padding: 24px;
            border-radius: var(--radius);
            height: auto;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            backdrop-filter: var(--glass-blur);
            box-shadow: var(--shadow);
        }

        .doc-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .doc-preview {
            font-size: 15px;
            color: var(--text-sec);
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            line-height: 1.6;
            margin-top: 12px;
            margin-bottom: 24px;
        }

        .doc-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-sec);
        }

        /* Overlays */
        /* Share Sheet */
        .share-sheet {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 120;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .share-sheet.active {
            opacity: 1;
            pointer-events: auto;
        }

        .share-card {
            width: min(560px, 94vw);
            margin: 0 auto 24px;
            background: var(--glass-bg);
            border-radius: 18px;
            border: none;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.2);
            padding: 20px;
            transform: translateY(20px);
            transition: transform 0.2s ease;
            backdrop-filter: var(--glass-blur);
        }

        .share-sheet.active .share-card {
            transform: translateY(0);
        }

        .share-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
        }

        .share-title {
            font-size: 18px;
            font-weight: 700;
        }

        .share-subtitle {
            font-size: 12px;
            color: var(--text-sec);
            margin-top: 4px;
        }

        .share-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .share-action {
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.05));
            border: none;
            border-radius: 12px;
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.2s;
            font-family: inherit;
            color: var(--text-main);
            backdrop-filter: var(--glass-blur);
        }

        .share-action i {
            font-size: 22px;
            color: var(--primary);
        }

        .share-action span {
            font-size: 12px;
        }

        .share-action:hover {
            background: rgba(10, 132, 255, 0.16);
        }

        .share-tip {
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-sec);
            background: rgba(0, 0, 0, 0.04);
            padding: 8px 10px;
            border-radius: 8px;
        }

        /* Print Layout */
        #print-root {
            display: none;
            background: #fff;
        }

        #print-paper {
            width: 100%;
        }

        @media print {
            @page {
                size: A4;
                margin: 22mm 20mm;
            }

            body {
                background: #fff;
                height: auto;
                overflow: visible;
            }

            body > *:not(#print-root) {
                display: none !important;
            }

            #print-root {
                display: block;
            }

            .paper {
                padding: 0;
                min-height: auto;
            }
        }

        /* Common */
        .overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-body);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            height: 60px;
            background: var(--glass-bg);
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
            backdrop-filter: var(--glass-blur);
            box-shadow: 0 8px 30px rgba(15, 23, 42, 0.12);
        }

        .editor-area {
            flex: 1;
            max-width: 960px;
            width: 100%;
            margin: 0 auto;
            padding: 32px 24px 60px;
            overflow-y: auto;
        }

        .editor-sheet {
            background: var(--editor-paper);
            border-radius: 20px;
            border: 1px solid var(--editor-paper-border);
            box-shadow: var(--editor-paper-shadow);
            padding: 48px 56px 72px;
            min-height: 70vh;
        }

        .editor-body-wrap {
            position: relative;
            min-height: 60vh;
        }

        #doc-title {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.2;
            border: none;
            background: transparent;
            width: 100%;
            margin-bottom: 20px;
            color: var(--text-main);
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: anywhere;
            outline: none;
            min-height: 44px;
        }

        #doc-title:empty::before {
            content: attr(data-placeholder);
            color: var(--text-sec);
        }

        #doc-body {
            width: 100%;
            min-height: 60vh;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            color: var(--text-main);
            line-height: 1.7;
            white-space: pre-wrap;
            font-size: 18px;
            position: relative;
            z-index: 2;
        }

        #doc-body:focus {
            outline: none;
        }

        #doc-body:empty::before {
            content: attr(data-placeholder);
            color: var(--text-sec);
        }

        .collab-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 3;
        }

        .collab-selection {
            position: absolute;
            border-radius: 4px;
            opacity: 0.3;
        }

        .collab-caret {
            position: absolute;
            width: 2px;
            border-radius: 2px;
        }

        .collab-label {
            position: absolute;
            padding: 2px 6px;
            font-size: 10px;
            color: #fff;
            border-radius: 6px;
            transform: translateY(-100%);
            white-space: nowrap;
        }

        /* Reader */
        .reader-layout {
            display: flex;
            height: calc(100vh - 60px);
        }

        .reader-text-area {
            flex: 2;
            padding: 60px;
            overflow-y: auto;
            border-right: 1px solid var(--separator);
            background: var(--bg-card);
            position: relative;
        }

        .reader-notes-area {
            flex: 1;
            padding: 24px;
            background: var(--bg-body);
            overflow-y: auto;
            min-width: 320px;
        }

        .reader-content {
            white-space: pre-wrap;
            color: var(--text-main);
            line-height: 1.8;
            word-wrap: break-word;
        }

        .highlight {
            background-color: rgba(255, 214, 10, 0.4);
            border-bottom: 2px solid #FFD60A;
            cursor: pointer;
            border-radius: 2px;
            transition: 0.2s;
        }

        .highlight:hover {
            background-color: rgba(255, 214, 10, 0.7);
        }

        .note-card {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--separator);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .note-quote {
            border-left: 3px solid #FFD60A;
            padding-left: 8px;
            color: var(--text-sec);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 600;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-text {
            font-size: 15px;
            color: var(--text-main);
            line-height: 1.5;
        }

        .toolbar-control {
            background: var(--glass-bg);
            border: none;
            border-radius: 10px;
            padding: 6px 12px;
            font-size: 14px;
            color: var(--text-main);
            margin-left: 8px;
            font-weight: 500;
            backdrop-filter: var(--glass-blur);
        }

        .num-input {
            width: 60px;
            text-align: center;
        }

        /* Auth */
        .auth-page {
            min-height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: var(--bg-body);
        }

        .auth-frame {
            width: min(96vw, calc(90vh * 16 / 9), 1400px);
            aspect-ratio: 16 / 9;
            max-width: 96vw;
            max-height: 90vh;
            background: var(--auth-surface);
            border: none;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(15, 23, 42, 0.12);
            backdrop-filter: var(--glass-blur);
        }

        .auth-split {
            display: flex;
            height: 100%;
            width: 100%;
        }

        .auth-img {
            flex: 2.2;
            background: #000;
            position: relative;
        }

        .auth-img div {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            transition: opacity 1s;
            opacity: 0;
        }

        .auth-img div.active {
            opacity: 1;
        }

        .auth-form {
            flex: 1;
            max-width: none;
            width: 100%;
            background: var(--auth-surface);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 60px 6vw;
            align-items: flex-start;
            gap: 24px;
            overflow-y: auto;
        }

        .auth-inner {
            width: min(480px, 100%);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auth-mark {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, #0EA5E9, #2563EB);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .auth-brand-title {
            font-size: 18px;
            font-weight: 700;
        }

        .auth-brand-sub {
            font-size: 12px;
            color: var(--text-sec);
            margin-top: 2px;
        }

        .auth-title {
            margin: 0 0 6px;
            font-size: 26px;
            font-weight: 700;
        }

        .auth-subtitle {
            margin: 0;
            font-size: 14px;
            color: var(--text-sec);
        }

        .auth-card {
            display: flex;
            flex-direction: column;
            gap: 14px;
            background: var(--auth-card);
            border: none;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
            backdrop-filter: var(--glass-blur);
        }

        .auth-input {
            margin-top: 2px;
            background: var(--auth-input-bg);
            border: none;
            border-radius: 14px;
            padding: 12px 14px;
        }

        .auth-input:focus {
            background: var(--auth-card);
            border-color: #38bdf8;
            box-shadow: 0 0 0 3px var(--auth-input-focus);
        }

        .auth-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-sec);
            gap: 10px;
            flex-wrap: wrap;
        }

        .auth-remember {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .auth-switch {
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: inherit;
        }

        .auth-switch:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .auth-submit {
            width: 100%;
            height: 52px;
            border-radius: 14px;
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.22);
            font-size: 16px;
        }

        .auth-msg {
            text-align: center;
            color: #FF3B30;
            margin-top: 8px;
            font-size: 14px;
            min-height: 18px;
        }

        .captcha-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .captcha-canvas {
            width: 120px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
        }

        .captcha-input {
            flex: 1;
            min-width: 160px;
        }

        .captcha-refresh {
            border: none;
            background: transparent;
            color: var(--primary);
            cursor: pointer;
            font-size: 18px;
            padding: 6px;
            border-radius: 8px;
        }

        .captcha-refresh:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        /* ================== Paper Layout (PDF + Print) ================== */
        #pdf-staging-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 794px;
            background: #fff;
            padding: 0;
            color: #111;
            font-family: "Times New Roman", "Noto Serif SC", "Songti SC", serif;
            z-index: -1;
            pointer-events: none;
        }

        .paper {
            position: relative;
            background: #fff;
            color: #111;
            font-family: "Times New Roman", "Noto Serif SC", "Songti SC", serif;
            padding: 64px 58px;
            min-height: 1123px;
            box-sizing: border-box;
        }

        .paper-content {
            position: relative;
            z-index: 2;
        }

        .paper-header {
            text-align: center;
            margin-bottom: 16pt;
        }

        .paper-title {
            font-size: 22pt;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .paper-author {
            font-size: 11pt;
            margin-top: 6pt;
        }

        .paper-meta {
            font-size: 9pt;
            color: #666;
            margin-top: 4pt;
        }

        .paper-divider {
            border: none;
            border-top: 1px solid #ddd;
            margin: 12pt 0 16pt;
        }

        .paper-section-title {
            font-size: 12pt;
            font-weight: 700;
            margin: 12pt 0 6pt;
        }

        .paper-abstract {
            font-size: 11pt;
            line-height: 1.7;
            text-align: justify;
            text-indent: 2em;
            margin: 0;
        }

        .paper-keywords {
            font-size: 10pt;
            color: #444;
            margin-top: 6pt;
        }

        .paper-body {
            font-size: 12pt;
            line-height: 1.9;
            text-align: justify;
            word-break: break-word;
        }

        .paper-body p {
            text-indent: 2em;
            margin: 0 0 10pt;
        }

        .paper-body h2,
        .paper-body h3,
        .paper-body h4 {
            margin: 12pt 0 6pt;
            font-weight: 700;
            text-indent: 0;
        }

        .paper-body h2 {
            font-size: 14pt;
        }

        .paper-body h3 {
            font-size: 12.5pt;
        }

        .paper-body h4 {
            font-size: 12pt;
        }

        .paper-notes {
            margin-top: 16pt;
            font-size: 10pt;
            color: #333;
        }

        .paper-note-item {
            margin-bottom: 6pt;
        }

        .paper-footer {
            margin-top: 18pt;
            text-align: right;
            font-size: 9pt;
            color: #777;
        }

        .paper-watermark {
            position: absolute;
            inset: 0;
            display: grid;
            pointer-events: none;
            opacity: 0.06;
            z-index: 1;
        }

        .paper-watermark-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48pt;
            color: #000;
            letter-spacing: 6px;
            transform: rotate(-24deg);
            white-space: nowrap;
        }

        /* Share Preview */
        .share-preview {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 130;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .share-preview.active {
            opacity: 1;
            pointer-events: auto;
        }

        .share-preview-card {
            width: min(980px, 94vw);
            max-height: 90vh;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--separator);
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .share-preview-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--separator);
        }

        .share-preview-title {
            font-size: 16px;
            font-weight: 700;
        }

        .share-preview-subtitle {
            font-size: 12px;
            color: var(--text-sec);
            margin-top: 4px;
        }

        .share-preview-body {
            padding: 16px;
            background: var(--bg-body);
            overflow: auto;
            display: flex;
            justify-content: center;
        }

        .share-preview-canvas {
            width: 794px;
            transform: scale(0.74);
            transform-origin: top center;
            margin: 0 auto;
        }

        .share-preview-canvas .paper {
            box-shadow: 0 20px 50px rgba(15, 23, 42, 0.2);
        }

        .share-preview-actions {
            padding: 16px 20px;
            border-top: 1px solid var(--separator);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Mobile */
        .mobile-tab-bar {
            display: none;
        }

        @media (max-width: 768px) {
            .auth-page {
                padding: 0;
                align-items: stretch;
            }

            .auth-frame {
                width: 100%;
                min-height: 100vh;
                aspect-ratio: auto;
                border-radius: 0;
                border: none;
                box-shadow: none;
            }

            .auth-split {
                height: auto;
                flex-direction: column;
            }

            .auth-img {
                display: none;
            }

            .auth-form {
                padding: 32px 20px;
                align-items: center;
            }

            .auth-inner {
                width: 100%;
                max-width: 440px;
            }

            .auth-card {
                background: var(--auth-card);
                border: none;
                border-radius: 16px;
                padding: 22px;
                box-shadow: 0 16px 34px rgba(0, 0, 0, 0.08);
            }

            .auth-title {
                font-size: 22px;
            }

            .share-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .share-card {
                margin-bottom: 90px;
            }

            .share-preview-card {
                width: 96vw;
            }

            .share-preview-body {
                padding: 12px;
            }

            .share-preview-canvas {
                transform: scale(0.56);
            }

            .sidebar {
                display: none;
            }

            .mobile-tab-bar {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--bg-card);
                border-top: 1px solid var(--separator);
                padding-bottom: env(safe-area-inset-bottom);
                z-index: 90;
                justify-content: space-around;
            }

            .tab-item {
                flex: 1;
                text-align: center;
                padding: 10px 0;
                color: var(--text-sec);
                font-size: 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }

            .tab-item.active {
                color: var(--primary);
            }

            .main-content {
                padding: 20px 16px 100px 16px;
            }

            .editor-area {
                padding: 20px 14px 90px;
            }

            .editor-sheet {
                padding: 28px 20px 48px;
                border-radius: 16px;
            }

            #doc-title {
                font-size: 28px;
            }

            .reader-layout {
                flex-direction: column;
            }

            .reader-text-area {
                padding: 24px;
                border-right: none;
                height: auto;
                overflow: visible;
            }

            .reader-notes-area {
                height: auto;
                min-width: 100%;
                border-top: 1px solid var(--separator);
                padding-bottom: 120px;
            }

            .stats-container,
            .doc-list {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 28px;
            }
        }
    </style>
</head>

<body>

    <div id="pdf-staging-area"></div>

    <div id="view-auth" class="auth-page">
        <div class="auth-frame">
            <div class="auth-split">
                <div class="auth-img">
                    <div id="bg-1" class="active"></div>
                    <div id="bg-2"></div>
                </div>
                <div class="auth-form">
                    <div class="auth-inner">
                        <div class="auth-brand">
                            <div class="auth-mark">&</div>
                            <div>
                                <div class="auth-brand-title">Smart Reader</div>
                                <div class="auth-brand-sub">极简创作与沉浸阅读</div>
                            </div>
                        </div>
                        <div>
                            <h1 id="auth-title" class="auth-title">欢迎回来</h1>
                            <p id="auth-subtitle" class="auth-subtitle">继续你的阅读进度</p>
                        </div>
                        <div class="auth-card">
                            <input type="email" id="email" class="input-clean auth-input" placeholder="邮箱">
                            <input type="password" id="password" class="input-clean auth-input" placeholder="密码">
                            <div class="captcha-row">
                                <canvas id="captcha-canvas" class="captcha-canvas" width="120" height="40"></canvas>
                                <input type="text" id="captcha-input"
                                    class="input-clean auth-input captcha-input" placeholder="输入验证码">
                                <button class="captcha-refresh" type="button" onclick="refreshCaptcha()" title="换一题">
                                    <i class="ph ph-arrow-clockwise"></i>
                                </button>
                            </div>
                            <div class="auth-row">
                                <label class="auth-remember"><input type="checkbox" id="remember"> 14天免登录</label>
                                <button class="auth-switch" type="button" onclick="toggleAuth()"
                                    id="auth-switch">没有账号？去注册</button>
                            </div>
                            <button class="btn-primary auth-submit" onclick="handleAuth()" id="auth-btn">登录</button>
                            <div id="auth-msg" class="auth-msg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-app" class="app-container hidden">
        <nav class="sidebar">
            <div class="user-card">
                <img id="nav-avatar" class="user-avatar">
                <div style="overflow:hidden;">
                    <div style="font-weight:700; font-size:16px;" id="nav-name">User</div>
                    <div style="font-size:12px; color:var(--text-sec);">已登录</div>
                </div>
            </div>
            <div class="nav-item active" onclick="showPage('dashboard')" id="tab-dash-pc"><i class="ph ph-squares-four"
                    style="font-size:20px;"></i> 文库</div>
            <div class="nav-item" onclick="showPage('settings')" id="tab-set-pc"><i class="ph ph-gear"
                    style="font-size:20px;"></i> 设置</div>
            <div style="margin-top:auto;">
                <div class="nav-item" onclick="signOut()" style="color:#FF3B30;"><i class="ph ph-sign-out"
                        style="font-size:20px;"></i> 退出</div>
            </div>
        </nav>

        <main class="main-content">
            <div id="page-dashboard">
                <div class="page-header">
                    <div class="page-title">文库</div><button class="btn btn-circle" onclick="openEditor(null)"><i
                            class="ph ph-plus" style="font-weight:bold;"></i></button>
                </div>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">ARTICLES</div>
                        <div class="stat-value" id="stat-count">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">WORDS</div>
                        <div class="stat-value" id="stat-words">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">READ TIME</div>
                        <div class="stat-value" id="stat-time">0h 0m</div>
                    </div>
                </div>
                <div id="doc-list" class="doc-list">加载中...</div>
            </div>

            <div id="page-settings" class="hidden">
                <div class="page-header">
                    <div class="page-title">设置</div>
                </div>
                <div style="max-width:600px; margin:0 auto;">
                    <div
                        style="background:var(--bg-card); border-radius:12px; border:1px solid var(--separator); overflow:hidden; margin-bottom:24px;">
                        <div
                            style="padding:16px; border-bottom:1px solid var(--separator); display:flex; justify-content:space-between; align-items:center;">
                            <span>昵称</span>
                            <div style="display:flex; gap:10px;"><input type="text" id="set-name" class="input-clean"
                                    style="width:120px; padding:6px;"><button class="btn-text"
                                    onclick="updateName()">保存</button></div>
                        </div>
                        <div
                            style="padding:16px; border-bottom:1px solid var(--separator); display:flex; justify-content:space-between; align-items:center;">
                            <span>头像</span>
                            <div style="display:flex; align-items:center; gap:10px;"><img id="setting-avatar-preview"
                                    style="width:36px; height:36px; border-radius:50%; object-fit:cover;"><input
                                    type="file" id="avatar-upload" hidden onchange="uploadAvatar(this)"><button
                                    class="btn-text"
                                    onclick="document.getElementById('avatar-upload').click()">更换</button></div>
                        </div>
                        <div style="padding:16px; display:flex; justify-content:space-between; align-items:center;">
                            <span>重置密码</span><button class="btn-text danger" onclick="sendPasswordReset()">发送邮件</button>
                        </div>
                    </div>
                    <div
                        style="background:var(--bg-card); border-radius:12px; border:1px solid var(--separator); overflow:hidden;">
                        <div style="padding:16px; display:flex; justify-content:space-between; align-items:center;">
                            <span>深色模式</span><select id="theme-select" class="toolbar-control"
                                onchange="setTheme(this.value)">
                                <option value="system">系统</option>
                                <option value="light">浅色</option>
                                <option value="dark">深色</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-group"
                        style="border:none; background:transparent; margin-top:20px; display:none;" id="mobile-logout">
                        <button class="btn-primary" style="width:100%; background:#FF3B30;"
                            onclick="signOut()">退出登录</button>
                    </div>
                </div>
            </div>
        </main>

        <div class="mobile-tab-bar">
            <div class="tab-item active" onclick="showPage('dashboard')" id="tab-dash-mb"><i class="ph ph-squares-four"
                    style="font-size:24px;"></i><span style="font-size:10px;">文库</span></div>
            <div class="tab-item" onclick="openEditor(null)"><i class="ph ph-plus-circle"
                    style="font-size:28px; color:var(--primary);"></i></div>
            <div class="tab-item" onclick="showPage('settings')" id="tab-set-mb"><i class="ph ph-gear"
                    style="font-size:24px;"></i><span style="font-size:10px;">设置</span></div>
        </div>
    </div>

    <div id="view-editor" class="overlay hidden">
        <div class="toolbar">
            <button class="btn-back" onclick="closeEditor()"><i class="ph ph-caret-left"></i> 返回</button>
            <div style="display:flex; align-items:center;">
                <select id="editor-font" class="toolbar-control" onchange="syncFont()">
                    <option value="system">Sans</option>
                    <option value="serif">Serif</option>
                    <option value="mono">Mono</option>
                </select>
                <input type="number" id="editor-size" class="toolbar-control num-input" value="18"
                    onchange="validateFontSize(this)" oninput="syncFont()">
            </div>
            <div style="display:flex; gap:8px; align-items:center;"><span id="save-status"
                    style="font-size:11px; color:var(--text-sec);">已保存</span><button class="btn-text"
                    style="font-weight:600;" onclick="saveDoc(true)">完成</button></div>
        </div>
        <div class="editor-area">
            <div class="editor-sheet">
                <div id="doc-title" contenteditable="plaintext-only" spellcheck="false" data-placeholder="输入标题"
                    oninput="triggerAutoSave()"></div>
                <div class="editor-body-wrap">
                    <div id="doc-body" contenteditable="plaintext-only" spellcheck="false" data-placeholder="输入正文..."
                        oninput="triggerAutoSave()"></div>
                    <div id="collab-layer" class="collab-layer"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-reader" class="overlay hidden">
        <div class="toolbar">
            <button class="btn-back" onclick="closeReader()"><i class="ph ph-caret-left"></i> 返回</button>

            <div style="display:flex; align-items:center; gap:8px;">
                <div style="font-size:12px; color:var(--text-sec); font-variant-numeric:tabular-nums;"
                    id="reader-timer-display">00:00</div>

                <select id="reader-font-select" class="toolbar-control" onchange="syncReaderFont()">
                    <option value="system">Sans</option>
                    <option value="serif">Serif</option>
                    <option value="mono">Mono</option>
                </select>
                <input type="number" id="reader-size-input" class="toolbar-control num-input" value="18"
                    onchange="validateFontSize(this)" oninput="syncReaderFont()">
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="btn-icon-sm" onclick="openShare()" title="分享/导出"><i class="ph ph-share-network"
                        style="font-size:20px;"></i></button>
                <button class="btn-text" onclick="switchToEdit()">编辑</button>
            </div>
        </div>
        <div class="reader-layout">
            <div class="reader-text-area">
                <h1 id="reader-title" style="margin-bottom:30px; font-size:32px; font-weight:800;"></h1>
                <div id="reader-body" class="reader-content"></div>
            </div>
            <div class="reader-notes-area">
                <div
                    style="font-size:12px; font-weight:700; color:var(--text-sec); margin-bottom:15px; text-transform:uppercase;">
                    笔记</div>
                <div id="reader-notes-list"></div>
            </div>
        </div>
    </div>

    <div id="share-sheet" class="share-sheet hidden" onclick="closeShare(true)">
        <div class="share-card" onclick="event.stopPropagation()">
            <div class="share-header">
                <div>
                    <div class="share-title">分享文章</div>
                    <div id="share-doc-title" class="share-subtitle">未命名</div>
                    <div id="share-doc-meta" class="share-subtitle">论文排版 · PDF</div>
                </div>
                <button class="btn-text" onclick="closeShare()">关闭</button>
            </div>
            <div class="share-actions">
                <button class="share-action" onclick="shareDoc('pdf')">
                    <i class="ph ph-file-pdf"></i><span>预览并导出</span>
                </button>
                <button class="share-action" onclick="shareDoc('copy-title')">
                    <i class="ph ph-text-aa"></i><span>复制标题</span>
                </button>
                <button class="share-action" onclick="shareDoc('copy-all')">
                    <i class="ph ph-copy"></i><span>复制全文</span>
                </button>
                <button class="share-action" onclick="shareDoc('download')">
                    <i class="ph ph-file-text"></i><span>下载 TXT</span>
                </button>
            </div>
            <div id="share-tip" class="share-tip">将生成论文排版 PDF（含水印），可直接分享或下载。</div>
        </div>
    </div>

    <div id="share-preview" class="share-preview hidden" onclick="closeSharePreview(true)">
        <div class="share-preview-card" onclick="event.stopPropagation()">
            <div class="share-preview-header">
                <div>
                    <div class="share-preview-title">论文排版预览</div>
                    <div id="share-preview-subtitle" class="share-preview-subtitle">未命名</div>
                </div>
                <button class="btn-text" onclick="closeSharePreview()">关闭</button>
            </div>
            <div class="share-preview-body">
                <div id="share-preview-canvas" class="share-preview-canvas"></div>
            </div>
            <div class="share-preview-actions">
                <button class="btn-text" onclick="closeSharePreview('back')">返回分享</button>
                <button class="btn-primary" onclick="exportToPDF()">导出 PDF</button>
            </div>
        </div>
    </div>

    <div id="print-root">
        <div id="print-paper"></div>
    </div>

    <script>
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co';
        const supabaseKey = 'sb_publishable_T98_plQu34_E_dqLCztSjw_AeDL1Fq0';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        const bgImages = [
            'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1400&q=60',
            'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=1400&q=60',
            'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=1400&q=60'
        ];
        const CACHE_KEYS = {
            docs: 'sr_docs_cache',
            notes: 'sr_notes_cache',
            meta: 'sr_cache_meta'
        };

        let currentUser = null;
        let isSignup = false;
        let currentDocId = null;
        let saveTimer = null;
        let bgIdx = 0;
        let activeNotes = [];
        let captchaAnswer = '';
        let editorHistory = null;
        let realtimeChannel = null;
        let readingTimer = null;
        let sessionSeconds = 0;
        let docTotalSeconds = 0;
        let collabDoc = null;
        let collabProvider = null;
        let collabText = null;
        let collabTitle = null;
        let collabAwareness = null;
        let collabRoomId = null;
        let collabOrigin = null;
        let collabSaveTimer = null;
        let collabSelectionTimer = null;
        let collabTextObserver = null;
        let collabTitleObserver = null;
        let collabAwarenessObserver = null;
        let collabSelectionListener = null;
        let collabInputListener = null;
        let collabTitleInputListener = null;
        let collabPasteListener = null;
        let collabScrollListener = null;
        let suppressEditorSync = false;
        const collabColors = ['#0A84FF', '#34D399', '#F97316', '#A855F7', '#14B8A6', '#F43F5E', '#FACC15'];
        const bgPreload = new Map();

        class HistoryManager {
            constructor(textareaId) {
                this.editor = document.getElementById(textareaId);
                this.stack = [];
                this.pointer = -1;
                this.max = 80;
                if (!this.editor) return;

                this.editor.addEventListener('input', () => {
                    this.save(getEditorValue(this.editor));
                });

                this.editor.addEventListener('keydown', (e) => {
                    if (!(e.metaKey || e.ctrlKey)) return;
                    if (e.key.toLowerCase() !== 'z') return;
                    e.preventDefault();
                    if (e.shiftKey) this.redo();
                    else this.undo();
                });
            }

            save(value) {
                if (this.pointer >= 0 && this.stack[this.pointer] === value) return;
                this.stack = this.stack.slice(0, this.pointer + 1);
                this.stack.push(value);
                if (this.stack.length > this.max) this.stack.shift();
                this.pointer = this.stack.length - 1;
            }

            undo() {
                if (!this.editor || this.pointer <= 0) return;
                this.pointer -= 1;
                setEditorValue(this.editor, this.stack[this.pointer]);
            }

            redo() {
                if (!this.editor || this.pointer >= this.stack.length - 1) return;
                this.pointer += 1;
                setEditorValue(this.editor, this.stack[this.pointer]);
            }
        }

        function getEditorEl() {
            return document.getElementById('doc-body');
        }

        function getTitleEl() {
            return document.getElementById('doc-title');
        }

        function normalizeTitleText(text) {
            return normalizeEditorText(text || '').replace(/\s*\n+\s*/g, ' ').trim();
        }

        function normalizeEditorText(text) {
            return (text || '').replace(/\r\n/g, '\n');
        }

        function getEditorValue(el) {
            if (!el) return '';
            if (el.isContentEditable) return normalizeEditorText(el.innerText);
            return normalizeEditorText(el.value);
        }

        function setEditorValue(el, value) {
            if (!el) return;
            const text = normalizeEditorText(value || '');
            if (el.isContentEditable) {
                el.textContent = text;
            } else {
                el.value = text;
            }
        }

        function getEditorContent() {
            return getEditorValue(getEditorEl());
        }

        function getTitleValue() {
            const el = getTitleEl();
            return el ? normalizeTitleText(getEditorValue(el)) : '';
        }

        function setEditorContent(value, options = {}) {
            const el = getEditorEl();
            if (!el) return;
            const { silent = false } = options;
            setEditorValue(el, value);
            if (!silent && editorHistory) editorHistory.save(getEditorValue(el));
        }

        function setTitleValue(value, options = {}) {
            const el = getTitleEl();
            if (!el) return;
            setEditorValue(el, value || '');
        }

        function readCache(key) {
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : null;
            } catch (e) {
                return null;
            }
        }

        function writeCache(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                return;
            }
        }

        function getDocsCache() {
            const docs = readCache(CACHE_KEYS.docs);
            return Array.isArray(docs) ? docs : null;
        }

        function setDocsCache(docs) {
            writeCache(CACHE_KEYS.docs, sortDocs(docs || []));
            writeCache(CACHE_KEYS.meta, { updatedAt: Date.now() });
        }

        function getDocCache(id) {
            const docs = getDocsCache();
            if (!docs) return null;
            return docs.find((doc) => doc.id === id) || null;
        }

        function setDocCache(doc) {
            if (!doc) return;
            updateDocsCache(doc);
        }

        function getNotesCache(docId) {
            const notesMap = readCache(CACHE_KEYS.notes);
            if (!notesMap || typeof notesMap !== 'object') return null;
            return Array.isArray(notesMap[docId]) ? notesMap[docId] : null;
        }

        function setNotesCache(docId, notes) {
            const notesMap = readCache(CACHE_KEYS.notes) || {};
            notesMap[docId] = Array.isArray(notes) ? notes : [];
            writeCache(CACHE_KEYS.notes, notesMap);
        }

        function sortDocs(docs) {
            return [...docs].sort((a, b) => {
                const aDate = new Date(a.updated_at || a.created_at || 0).getTime();
                const bDate = new Date(b.updated_at || b.created_at || 0).getTime();
                return bDate - aDate;
            });
        }

        function docsEqual(a, b) {
            if (!Array.isArray(a) || !Array.isArray(b)) return false;
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i += 1) {
                const docA = a[i];
                const docB = b[i];
                if (!docA || !docB) return false;
                if (docA.id !== docB.id) return false;
                if ((docA.updated_at || docA.created_at || '') !== (docB.updated_at || docB.created_at || '')) return false;
                if ((docA.title || '') !== (docB.title || '')) return false;
                if ((docA.content || '') !== (docB.content || '')) return false;
                if ((docA.reading_seconds || 0) !== (docB.reading_seconds || 0)) return false;
            }
            return true;
        }

        function notesEqual(a, b) {
            if (!Array.isArray(a) || !Array.isArray(b)) return false;
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i += 1) {
                const na = a[i];
                const nb = b[i];
                if (!na || !nb) return false;
                if (na.id !== nb.id) return false;
                if ((na.note || '') !== (nb.note || '')) return false;
                if ((na.highlight_text || '') !== (nb.highlight_text || '')) return false;
                if ((na.start_index || 0) !== (nb.start_index || 0)) return false;
                if ((na.end_index || 0) !== (nb.end_index || 0)) return false;
            }
            return true;
        }

        function updateDocsCache(doc) {
            const docs = getDocsCache() || [];
            const idx = docs.findIndex((item) => item.id === doc.id);
            if (idx >= 0) docs[idx] = { ...docs[idx], ...doc };
            else docs.push(doc);
            setDocsCache(docs);
        }

        function removeDocFromCache(id) {
            const docs = getDocsCache() || [];
            const next = docs.filter((doc) => doc.id !== id);
            setDocsCache(next);
            const notesMap = readCache(CACHE_KEYS.notes) || {};
            if (notesMap && notesMap[id]) {
                delete notesMap[id];
                writeCache(CACHE_KEYS.notes, notesMap);
            }
        }

        function clearDocCache() {
            localStorage.removeItem(CACHE_KEYS.docs);
            localStorage.removeItem(CACHE_KEYS.notes);
            localStorage.removeItem(CACHE_KEYS.meta);
        }

        function setupPointerGlow() {
            let raf = null;
            let latest = { x: window.innerWidth * 0.5, y: window.innerHeight * 0.2 };
            const update = (x, y) => {
                const px = Math.max(0, Math.min(100, (x / window.innerWidth) * 100));
                const py = Math.max(0, Math.min(100, (y / window.innerHeight) * 100));
                document.body.style.setProperty('--cursor-x', `${px}%`);
                document.body.style.setProperty('--cursor-y', `${py}%`);
            };
            const handle = (e) => {
                latest = { x: e.clientX, y: e.clientY };
                if (raf) return;
                raf = requestAnimationFrame(() => {
                    update(latest.x, latest.y);
                    raf = null;
                });
            };
            document.addEventListener('pointermove', handle, { passive: true });
            document.addEventListener('pointerdown', handle, { passive: true });
            update(latest.x, latest.y);
        }

        function shouldUseAuthImages() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (!connection) return true;
            if (connection.saveData) return false;
            return !/2g/.test(connection.effectiveType || '');
        }

        function preloadBgImage(url) {
            if (bgPreload.has(url)) return bgPreload.get(url);
            const img = new Image();
            img.decoding = 'async';
            img.loading = 'eager';
            img.src = url;
            const promise = img.decode ? img.decode().catch(() => { }) : new Promise((resolve) => {
                img.onload = resolve;
                img.onerror = resolve;
            });
            bgPreload.set(url, promise);
            return promise;
        }

        async function rotateAuthBackground() {
            if (!bgImages.length) return;
            bgIdx = (bgIdx + 1) % bgImages.length;
            const active = document.querySelector('.auth-img div.active');
            if (!active) return;
            const next = active.id === 'bg-1' ? document.getElementById('bg-2') : document.getElementById('bg-1');
            const nextUrl = bgImages[bgIdx];
            await preloadBgImage(nextUrl);
            next.style.backgroundImage = `url('${nextUrl}')`;
            next.classList.add('active');
            active.classList.remove('active');
        }

        function getCollabColor() {
            const seed = currentUser?.id || currentUser?.email || String(Math.random());
            let hash = 0;
            for (let i = 0; i < seed.length; i += 1) {
                hash = (hash << 5) - hash + seed.charCodeAt(i);
                hash |= 0;
            }
            const index = Math.abs(hash) % collabColors.length;
            return collabColors[index];
        }

        function applyTextDiff(ytext, nextValue, origin) {
            const next = normalizeEditorText(nextValue || '');
            const prev = ytext.toString();
            if (prev === next) return;
            let start = 0;
            while (start < prev.length && start < next.length && prev[start] === next[start]) start += 1;
            let endPrev = prev.length - 1;
            let endNext = next.length - 1;
            while (endPrev >= start && endNext >= start && prev[endPrev] === next[endNext]) {
                endPrev -= 1;
                endNext -= 1;
            }
            const deleteCount = endPrev - start + 1;
            const insertText = next.slice(start, endNext + 1);
            ytext.doc.transact(() => {
                if (deleteCount > 0) ytext.delete(start, deleteCount);
                if (insertText) ytext.insert(start, insertText);
            }, origin);
        }

        function getSelectionOffsets(root) {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return null;
            const range = selection.getRangeAt(0);
            if (!root.contains(range.startContainer)) return null;
            const preStart = range.cloneRange();
            preStart.selectNodeContents(root);
            preStart.setEnd(range.startContainer, range.startOffset);
            const start = preStart.toString().length;
            const preEnd = range.cloneRange();
            preEnd.selectNodeContents(root);
            preEnd.setEnd(range.endContainer, range.endOffset);
            const end = preEnd.toString().length;
            return { anchor: start, head: end };
        }

        function getRangeFromOffsets(root, start, end) {
            const range = document.createRange();
            if (!root) {
                range.setStart(document.body, 0);
                range.collapse(true);
                return range;
            }
            if (!root.textContent) {
                range.selectNodeContents(root);
                range.collapse(true);
                return range;
            }
            const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
            let current = 0;
            let startNode = null;
            let endNode = null;
            let startOffset = 0;
            let endOffset = 0;
            let node = walker.nextNode();
            while (node) {
                const len = node.textContent.length;
                if (!startNode && start <= current + len) {
                    startNode = node;
                    startOffset = Math.max(0, start - current);
                }
                if (!endNode && end <= current + len) {
                    endNode = node;
                    endOffset = Math.max(0, end - current);
                    break;
                }
                current += len;
                node = walker.nextNode();
            }
            if (!startNode) {
                range.selectNodeContents(root);
                range.collapse(false);
                return range;
            }
            if (!endNode) {
                endNode = startNode;
                endOffset = startOffset;
            }
            range.setStart(startNode, startOffset);
            range.setEnd(endNode, endOffset);
            return range;
        }

        function restoreSelectionOffsets(root, anchor, head) {
            const selection = window.getSelection();
            if (!selection || !root) return;
            const start = Math.min(anchor, head);
            const end = Math.max(anchor, head);
            const range = getRangeFromOffsets(root, start, end);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function focusBodyAtStart() {
            const editorEl = getEditorEl();
            if (!editorEl) return;
            editorEl.focus();
            const range = document.createRange();
            range.selectNodeContents(editorEl);
            range.collapse(true);
            const selection = window.getSelection();
            if (!selection) return;
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function handleTitleKeydown(e) {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            focusBodyAtStart();
        }

        function scheduleAwarenessUpdate() {
            if (collabSelectionTimer) return;
            collabSelectionTimer = requestAnimationFrame(() => {
                collabSelectionTimer = null;
                updateLocalAwareness();
            });
        }

        function updateLocalAwareness() {
            if (!collabAwareness) return;
            const editorEl = getEditorEl();
            if (!editorEl) return;
            const selection = getSelectionOffsets(editorEl);
            collabAwareness.setLocalStateField('cursor', selection);
        }

        function renderRemoteCursors() {
            const layer = document.getElementById('collab-layer');
            const editorEl = getEditorEl();
            if (!layer || !editorEl || !collabAwareness) return;
            layer.innerHTML = '';
            const editorRect = editorEl.getBoundingClientRect();
            const lineHeight = parseFloat(getComputedStyle(editorEl).lineHeight) || 20;

            collabAwareness.getStates().forEach((state, clientId) => {
                if (clientId === collabAwareness.clientID) return;
                const cursor = state.cursor;
                if (!cursor) return;
                const color = state.user?.color || '#0A84FF';
                const name = state.user?.name || '协作者';
                const start = Math.min(cursor.anchor, cursor.head);
                const end = Math.max(cursor.anchor, cursor.head);
                const range = getRangeFromOffsets(editorEl, start, end);
                const rects = Array.from(range.getClientRects());
                if (!rects.length) return;

                if (end > start) {
                    rects.forEach((rect) => {
                        const sel = document.createElement('div');
                        sel.className = 'collab-selection';
                        sel.style.background = color;
                        sel.style.left = `${rect.left - editorRect.left}px`;
                        sel.style.top = `${rect.top - editorRect.top}px`;
                        sel.style.width = `${rect.width}px`;
                        sel.style.height = `${rect.height || lineHeight}px`;
                        layer.appendChild(sel);
                    });
                }

                const caretRect = rects[rects.length - 1];
                const caret = document.createElement('div');
                caret.className = 'collab-caret';
                caret.style.background = color;
                caret.style.left = `${caretRect.right - editorRect.left}px`;
                caret.style.top = `${caretRect.top - editorRect.top}px`;
                caret.style.height = `${caretRect.height || lineHeight}px`;
                layer.appendChild(caret);

                const label = document.createElement('div');
                label.className = 'collab-label';
                label.style.background = color;
                label.style.left = `${caretRect.right - editorRect.left + 4}px`;
                label.style.top = `${caretRect.top - editorRect.top}px`;
                label.textContent = name;
                layer.appendChild(label);
            });
        }

        function scheduleCollabSave() {
            clearTimeout(collabSaveTimer);
            collabSaveTimer = setTimeout(() => {
                if (currentDocId) saveDoc(false, { silent: true, fromCollab: true });
            }, 2000);
        }

        function setupCollaboration(docId, initialContent = '', initialTitle = '') {
            if (!docId) return;
            if (!window.Y || !window.WebrtcProvider) return;
            if (collabRoomId === docId) {
                if (collabText && !collabText.length && initialContent) {
                    applyTextDiff(collabText, initialContent, collabOrigin);
                }
                if (collabTitle && !collabTitle.length && initialTitle) {
                    applyTextDiff(collabTitle, initialTitle, collabOrigin);
                }
                return;
            }
            teardownCollaboration();

            collabRoomId = docId;
            collabOrigin = Symbol(`collab-${docId}`);
            collabDoc = new Y.Doc();
            collabProvider = new WebrtcProvider(`sr-doc-${docId}`, collabDoc, {
                signaling: ['wss://signaling.yjs.dev']
            });
            if (window.IndexeddbPersistence) {
                new IndexeddbPersistence(`sr-doc-${docId}`, collabDoc);
            }
            collabText = collabDoc.getText('content');
            collabTitle = collabDoc.getText('title');
            collabAwareness = collabProvider.awareness;
            collabAwareness.setLocalStateField('user', {
                name: getAuthorName(),
                color: getCollabColor()
            });

            const editorEl = getEditorEl();
            if (editorEl) {
                collabInputListener = () => {
                    if (suppressEditorSync || !collabText) return;
                    const value = getEditorValue(editorEl);
                    applyTextDiff(collabText, value, collabOrigin);
                    scheduleAwarenessUpdate();
                };
                editorEl.addEventListener('input', collabInputListener);
                editorEl.addEventListener('keyup', scheduleAwarenessUpdate);
                editorEl.addEventListener('mouseup', scheduleAwarenessUpdate);
                collabPasteListener = (e) => {
                    e.preventDefault();
                    const text = e.clipboardData?.getData('text/plain') || '';
                    document.execCommand('insertText', false, text);
                };
                editorEl.addEventListener('paste', collabPasteListener);
            }

            const titleEl = getTitleEl();
            if (titleEl) {
                collabTitleInputListener = () => {
                    if (suppressEditorSync || !collabTitle) return;
                    const value = getEditorValue(titleEl);
                    applyTextDiff(collabTitle, value, collabOrigin);
                };
                titleEl.addEventListener('input', collabTitleInputListener);
            }

            const editorArea = document.querySelector('.editor-area');
            if (editorArea) {
                collabScrollListener = () => renderRemoteCursors();
                editorArea.addEventListener('scroll', collabScrollListener, { passive: true });
            }

            collabSelectionListener = () => scheduleAwarenessUpdate();
            document.addEventListener('selectionchange', collabSelectionListener);

            collabTextObserver = (event) => {
                if (event.transaction.origin === collabOrigin) return;
                const editorEl = getEditorEl();
                const selection = editorEl && document.activeElement === editorEl ? getSelectionOffsets(editorEl) : null;
                suppressEditorSync = true;
                setEditorContent(collabText.toString(), { silent: true });
                suppressEditorSync = false;
                if (selection && editorEl) restoreSelectionOffsets(editorEl, selection.anchor, selection.head);
                renderRemoteCursors();
                scheduleCollabSave();
            };
            collabText.observe(collabTextObserver);

            collabTitleObserver = (event) => {
                if (event.transaction.origin === collabOrigin) return;
                if (!collabTitle) return;
                suppressEditorSync = true;
                setTitleValue(collabTitle.toString(), { silent: true });
                suppressEditorSync = false;
                scheduleCollabSave();
            };
            collabTitle.observe(collabTitleObserver);

            collabAwarenessObserver = () => renderRemoteCursors();
            collabAwareness.on('change', collabAwarenessObserver);

            const applyInitial = () => {
                const yTitle = collabTitle ? collabTitle.toString() : '';
                if (yTitle) {
                    setTitleValue(yTitle, { silent: true });
                } else if (initialTitle && collabTitle) {
                    applyTextDiff(collabTitle, initialTitle, collabOrigin);
                }
                const yContent = collabText.toString();
                if (yContent) {
                    setEditorContent(yContent, { silent: true });
                } else if (initialContent) {
                    applyTextDiff(collabText, initialContent, collabOrigin);
                }
                scheduleAwarenessUpdate();
                renderRemoteCursors();
            };
            if (collabProvider.on) collabProvider.on('synced', applyInitial);
            setTimeout(applyInitial, 800);
        }

        function teardownCollaboration() {
            if (collabText && collabTextObserver) collabText.unobserve(collabTextObserver);
            if (collabTitle && collabTitleObserver) collabTitle.unobserve(collabTitleObserver);
            if (collabAwareness && collabAwarenessObserver) collabAwareness.off('change', collabAwarenessObserver);
            if (collabSelectionListener) document.removeEventListener('selectionchange', collabSelectionListener);

            const editorEl = getEditorEl();
            if (editorEl && collabInputListener) editorEl.removeEventListener('input', collabInputListener);
            if (editorEl && collabPasteListener) editorEl.removeEventListener('paste', collabPasteListener);
            if (editorEl) {
                editorEl.removeEventListener('keyup', scheduleAwarenessUpdate);
                editorEl.removeEventListener('mouseup', scheduleAwarenessUpdate);
            }
            const titleEl = getTitleEl();
            if (titleEl && collabTitleInputListener) titleEl.removeEventListener('input', collabTitleInputListener);
            const editorArea = document.querySelector('.editor-area');
            if (editorArea && collabScrollListener) editorArea.removeEventListener('scroll', collabScrollListener);

            if (collabProvider) collabProvider.destroy();
            if (collabDoc) collabDoc.destroy();
            const layer = document.getElementById('collab-layer');
            if (layer) layer.innerHTML = '';

            collabDoc = null;
            collabProvider = null;
            collabText = null;
            collabTitle = null;
            collabAwareness = null;
            collabRoomId = null;
            collabOrigin = null;
            collabTextObserver = null;
            collabTitleObserver = null;
            collabAwarenessObserver = null;
            collabSelectionListener = null;
            collabInputListener = null;
            collabTitleInputListener = null;
            collabPasteListener = null;
            collabScrollListener = null;
        }

        async function init() {
            const authImg = document.querySelector('.auth-img');
            if (authImg && shouldUseAuthImages()) {
                const bg = document.getElementById('bg-1');
                if (bg) bg.style.backgroundImage = `url('${bgImages[0]}')`;
                bgImages.forEach((url) => preloadBgImage(url));
                setInterval(rotateAuthBackground, 7000);
            } else if (authImg) {
                authImg.style.display = 'none';
            }

            const font = localStorage.getItem('pref_font') || 'system';
            const size = localStorage.getItem('pref_size') || '18';
            document.getElementById('editor-font').value = font;
            document.getElementById('editor-size').value = size;
            document.getElementById('reader-font-select').value = font;
            document.getElementById('reader-size-input').value = size;
            applyFontStyle(font, size);

            const theme = localStorage.getItem('pref_theme') || 'system';
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) themeSelect.value = theme;
            setTheme(theme);

            const media = window.matchMedia('(prefers-color-scheme: dark)');
            const handleSystemTheme = () => {
                if ((localStorage.getItem('pref_theme') || 'system') === 'system') setTheme('system');
            };
            if (media && media.addEventListener) media.addEventListener('change', handleSystemTheme);
            else if (media && media.addListener) media.addListener(handleSystemTheme);

            const { data: { session } } = await db.auth.getSession();
            if (session && (localStorage.getItem('remember') || sessionStorage.getItem('active'))) {
                sessionStorage.setItem('active', 'true');
                updateUser(session.user);
            }

            if (window.innerWidth < 768) {
                const mobileLogout = document.getElementById('mobile-logout');
                if (mobileLogout) mobileLogout.style.display = 'block';
            }

            updateAuthCopy();
            refreshCaptcha();
            setupPointerGlow();

            editorHistory = new HistoryManager('doc-body');
            const titleEl = getTitleEl();
            if (titleEl) titleEl.addEventListener('keydown', handleTitleKeydown);
            const readerBody = document.getElementById('reader-body');
            if (readerBody) readerBody.addEventListener('mouseup', handleSelection);

            window.addEventListener('beforeunload', () => stopReadingTimer());
        }

        function startReadingTimer(initialSeconds) {
            stopReadingTimer();
            const base = Number(initialSeconds);
            sessionSeconds = 0;
            docTotalSeconds = Number.isFinite(base) ? base : 0;
            updateTimerDisplay();
            readingTimer = setInterval(() => {
                if (document.visibilityState === 'visible') {
                    sessionSeconds += 1;
                    updateTimerDisplay();
                }
            }, 1000);
        }

        function stopReadingTimer() {
            if (readingTimer) {
                clearInterval(readingTimer);
                readingTimer = null;
            }
            if (currentDocId && sessionSeconds > 0) {
                const newTotal = docTotalSeconds + sessionSeconds;
                db.from('articles').update({ reading_seconds: newTotal }).eq('id', currentDocId).then();
                updateDocsCache({ id: currentDocId, reading_seconds: newTotal });
                docTotalSeconds = newTotal;
                sessionSeconds = 0;
                const docs = getDocsCache();
                if (docs && !document.getElementById('page-dashboard').classList.contains('hidden')) {
                    renderDocs(docs);
                }
            }
        }

        function updateTimerDisplay() {
            const total = docTotalSeconds + sessionSeconds;
            const h = Math.floor(total / 3600);
            const m = Math.floor((total % 3600) / 60);
            const s = total % 60;
            const text = h > 0 ? `${h}h ${m}m` : `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            document.getElementById('reader-timer-display').innerText = text;
        }

        function validateFontSize(input) {
            let val = parseInt(input.value, 10);
            if (Number.isNaN(val) || val < 16) val = 16;
            if (val > 42) val = 42;
            input.value = val;
            input.id === 'editor-size' ? syncFont() : syncReaderFont();
        }

        function syncFont() {
            saveAndApply(document.getElementById('editor-font').value, document.getElementById('editor-size').value);
        }

        function syncReaderFont() {
            saveAndApply(document.getElementById('reader-font-select').value, document.getElementById('reader-size-input').value);
        }

        function saveAndApply(f, s) {
            localStorage.setItem('pref_font', f);
            localStorage.setItem('pref_size', s);
            ['editor-font', 'reader-font-select'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = f;
            });
            ['editor-size', 'reader-size-input'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = s;
            });
            applyFontStyle(f, s);
        }

        function applyFontStyle(f, s) {
            const fonts = { system: '-apple-system, sans-serif', serif: 'Georgia, serif', mono: 'Menlo, monospace' };
            const cssF = fonts[f] || fonts.system;
            const cssS = `${s}px`;
            ['doc-body', 'reader-body'].forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.fontFamily = cssF;
                    el.style.fontSize = cssS;
                }
            });
            const titleEl = document.getElementById('doc-title');
            if (titleEl) titleEl.style.fontFamily = cssF;
            if (collabAwareness) renderRemoteCursors();
        }

        function updateAuthCopy() {
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const switchBtn = document.getElementById('auth-switch');
            const btn = document.getElementById('auth-btn');
            if (!title || !subtitle || !switchBtn || !btn) return;
            if (isSignup) {
                title.innerText = "创建你的账号";
                subtitle.innerText = "注册后将发送验证邮件";
                switchBtn.innerText = "已有账号？去登录";
                btn.innerText = "注册";
            } else {
                title.innerText = "欢迎回来";
                subtitle.innerText = "继续你的阅读进度";
                switchBtn.innerText = "没有账号？去注册";
                btn.innerText = "登录";
            }
        }

        function refreshCaptcha() {
            const canvas = document.getElementById('captcha-canvas');
            const input = document.getElementById('captcha-input');
            if (!canvas || !input) return;
            const ctx = canvas.getContext('2d');
            if (!ctx) return;
            const width = 120;
            const height = 40;
            const ratio = window.devicePixelRatio || 1;
            canvas.width = width * ratio;
            canvas.height = height * ratio;
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;
            ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 5; i += 1) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            captchaAnswer = code;

            const gradient = ctx.createLinearGradient(0, 0, width, height);
            gradient.addColorStop(0, '#f3f5f7');
            gradient.addColorStop(1, '#e8ebf0');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            for (let i = 0; i < 4; i += 1) {
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.beginPath();
                ctx.moveTo(Math.random() * width, Math.random() * height);
                ctx.lineTo(Math.random() * width, Math.random() * height);
                ctx.stroke();
            }
            for (let i = 0; i < 24; i += 1) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.12)';
                ctx.beginPath();
                ctx.arc(Math.random() * width, Math.random() * height, Math.random() * 1.4 + 0.6, 0, Math.PI * 2);
                ctx.fill();
            }

            const spacing = (width - 20) / 5;
            for (let i = 0; i < code.length; i += 1) {
                const ch = code[i];
                const x = 10 + i * spacing + Math.random() * 4;
                const y = 26 + Math.random() * 6;
                const angle = (Math.random() - 0.5) * 0.4;
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.fillStyle = `rgb(${70 + Math.random() * 100}, ${70 + Math.random() * 80}, ${70 + Math.random() * 80})`;
                ctx.font = '22px "Times New Roman", serif';
                ctx.fillText(ch, 0, 0);
                ctx.restore();
            }
            input.value = "";
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('auth-btn');
            const msg = document.getElementById('auth-msg');
            msg.innerText = "";
            if (!email || !password) return msg.innerText = "请填写完整";

            const captchaInput = document.getElementById('captcha-input').value.trim();
            if (!captchaInput) return msg.innerText = "请填写验证码";
            if (captchaInput.toLowerCase() !== captchaAnswer.toLowerCase()) {
                msg.innerText = "验证码错误，请重试";
                refreshCaptcha();
                return;
            }

            btn.innerText = "处理中...";
            let res;
            if (isSignup) res = await db.auth.signUp({ email, password });
            else res = await db.auth.signInWithPassword({ email, password });

            if (res.error) {
                msg.innerText = res.error.message;
                btn.innerText = isSignup ? "注册" : "登录";
                refreshCaptcha();
            } else {
                if (isSignup && !res.data.session) {
                    msg.innerText = "验证邮件已发送";
                    isSignup = false;
                    updateAuthCopy();
                    refreshCaptcha();
                } else {
                    if (document.getElementById('remember').checked) localStorage.setItem('remember', 'true');
                    sessionStorage.setItem('active', 'true');
                    updateUser(res.data.user);
                }
            }
        }

        function toggleAuth() {
            isSignup = !isSignup;
            const msg = document.getElementById('auth-msg');
            if (msg) msg.innerText = "";
            updateAuthCopy();
            refreshCaptcha();
        }

        function updateUser(user) {
            currentUser = user;
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('view-app').classList.remove('hidden');
            const name = user.user_metadata?.full_name || user.email.split('@')[0];
            const avatar = user.user_metadata?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${name}`;
            document.getElementById('nav-name').innerText = name;
            document.getElementById('nav-avatar').src = avatar;
            document.getElementById('setting-avatar-preview').src = avatar;
            document.getElementById('set-name').value = name;
            if (collabAwareness) {
                collabAwareness.setLocalStateField('user', {
                    name: getAuthorName(),
                    color: getCollabColor()
                });
            }
            subscribeRealtime();
            showPage('dashboard');
        }

        function countWords(s) {
            return s ? s.trim().split(/\s+/).length : 0;
        }

        function formatDuration(totalSeconds) {
            const seconds = Math.max(0, Math.floor(totalSeconds || 0));
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        }

        async function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                return;
            }
            const area = document.createElement('textarea');
            area.value = text;
            area.setAttribute('readonly', '');
            area.style.position = 'fixed';
            area.style.top = '-9999px';
            document.body.appendChild(area);
            area.select();
            try { document.execCommand('copy'); } finally { area.remove(); }
        }

        function escapeHtml(text) {
            return String(text || '')
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getAuthorName() {
            if (!currentUser) return 'Smart Reader';
            return currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'Smart Reader';
        }

        function sanitizeFileName(name) {
            const safe = (name || '').replace(/[\\/:*?"<>|]/g, '').trim();
            return safe || 'document';
        }

        function extractPaperSections(content) {
            const text = (content || '').trim();
            const paragraphs = text ? text.split(/\n{2,}/).map((p) => p.trim()).filter(Boolean) : [];
            let abstract = '';
            let bodyParagraphs = paragraphs;

            const abstractMatch = text.match(/(?:^|\n)(摘要|Abstract)[:：]\s*([\s\S]*?)(?=\n{2,}|$)/i);
            if (abstractMatch) {
                abstract = abstractMatch[2].trim();
                bodyParagraphs = paragraphs.filter((p) => p !== abstractMatch[0].trim());
            } else if (paragraphs.length > 0) {
                abstract = paragraphs[0];
                bodyParagraphs = paragraphs.slice(1);
            }

            const keywordMatch = text.match(/(?:关键词|Keywords)[:：]\s*([^\n]+)/i);
            let keywords = [];
            if (keywordMatch) {
                keywords = keywordMatch[1].split(/[，,;；]/).map((k) => k.trim()).filter(Boolean);
            }
            if (!keywords.length) keywords = ['智能阅读', '论文排版', '协作写作'];

            return {
                abstract,
                keywords,
                body: bodyParagraphs.length ? bodyParagraphs.join('\n\n') : text
            };
        }

        function estimatePaperPages(content) {
            const len = (content || '').replace(/\s/g, '').length;
            return Math.max(1, Math.ceil(len / 1800));
        }

        function buildWatermarkMarkup(text) {
            const mark = escapeHtml(text || '');
            const items = Array.from({ length: 12 }, () => `<div class="paper-watermark-item">${mark}</div>`).join('');
            return `<div class="paper-watermark">${items}</div>`;
        }

        function buildPaperBody(body) {
            const chunks = (body || '').split(/\n{2,}/).map((p) => p.trim()).filter(Boolean);
            if (!chunks.length) return '<p>（正文空白）</p>';
            return chunks.map((p) => {
                if (/^#{1,3}\s+/.test(p)) {
                    const level = p.match(/^#{1,3}/)[0].length;
                    const text = p.replace(/^#{1,3}\s+/, '');
                    const tag = level === 1 ? 'h2' : level === 2 ? 'h3' : 'h4';
                    return `<${tag}>${escapeHtml(text)}</${tag}>`;
                }
                return `<p>${escapeHtml(p).replace(/\n/g, '<br>')}</p>`;
            }).join('');
        }

        function buildPaperMarkup(payload) {
            const title = escapeHtml(payload.title || '未命名');
            const author = escapeHtml(payload.author || '');
            const meta = escapeHtml(payload.meta || '');
            const abstract = escapeHtml(payload.abstract || '').replace(/\n/g, '<br>');
            const keywords = payload.keywords && payload.keywords.length ? escapeHtml(payload.keywords.join('，')) : '';
            const notes = payload.notes || [];
            const notesHtml = notes.length ? `
                <div class="paper-notes">
                    <div class="paper-section-title">批注摘要</div>
                    ${notes.map((note) => `
                        <div class="paper-note-item">
                            <strong>${escapeHtml(note.highlight || '')}</strong>：${escapeHtml(note.note || '')}
                        </div>
                    `).join('')}
                </div>
            ` : '';
            const footer = escapeHtml(payload.footer || '');

            return `
                <div class="paper">
                    ${buildWatermarkMarkup(payload.watermark || 'Smart Reader')}
                    <div class="paper-content">
                        <div class="paper-header">
                            <div class="paper-title">${title}</div>
                            ${author ? `<div class="paper-author">${author}</div>` : ''}
                            ${meta ? `<div class="paper-meta">${meta}</div>` : ''}
                        </div>
                        <hr class="paper-divider">
                        <div class="paper-section-title">摘要</div>
                        <p class="paper-abstract">${abstract || '（无摘要）'}</p>
                        ${keywords ? `<div class="paper-keywords">关键词：${keywords}</div>` : ''}
                        <div class="paper-section-title">正文</div>
                        <div class="paper-body">${buildPaperBody(payload.body || '')}</div>
                        ${notesHtml}
                        ${footer ? `<div class="paper-footer">${footer}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function getPaperPayload(title, content) {
            const safeTitle = (title || '').trim() || '未命名';
            const safeContent = content || '';
            const sections = extractPaperSections(safeContent);
            const wordCount = countWords(safeContent);
            const pages = estimatePaperPages(safeContent);
            const date = new Date().toLocaleDateString();
            const author = getAuthorName();
            const notes = (activeNotes || []).map((note) => {
                let highlight = note.highlight_text || '';
                if (!highlight && typeof note.start_index === 'number' && typeof note.end_index === 'number') {
                    highlight = safeContent.substring(note.start_index, note.end_index);
                }
                return { highlight, note: note.note || '' };
            });

            return {
                title: safeTitle,
                author,
                meta: `字数 ${wordCount.toLocaleString()} · 约 ${pages} 页 · ${date}`,
                abstract: sections.abstract,
                keywords: sections.keywords,
                body: sections.body,
                notes,
                watermark: 'Smart Reader',
                footer: `Generated by Smart Reader · ${date}`,
                pages,
                wordCount
            };
        }

        function renderPaperTo(container, payload) {
            if (!container) return;
            container.innerHTML = buildPaperMarkup(payload);
        }

        function renderPrintContent(title, content) {
            const payload = getPaperPayload(title, content);
            renderPaperTo(document.getElementById('print-paper'), payload);
        }

        function openShare() {
            const sheet = document.getElementById('share-sheet');
            if (!sheet) return;
            const title = document.getElementById('reader-title').innerText || '未命名';
            const bodyEl = document.getElementById('reader-body');
            const content = bodyEl?.dataset?.raw || bodyEl?.innerText || '';
            const payload = getPaperPayload(title, content);
            document.getElementById('share-doc-title').innerText = payload.title;
            const meta = document.getElementById('share-doc-meta');
            if (meta) meta.innerText = `论文排版 · 约 ${payload.pages} 页`;
            const tip = document.getElementById('share-tip');
            if (tip) tip.innerText = "系统分享会打开论文排版打印，选择“保存为 PDF”。";
            sheet.classList.remove('hidden');
            requestAnimationFrame(() => sheet.classList.add('active'));
        }

        function closeShare(force) {
            const sheet = document.getElementById('share-sheet');
            if (!sheet || sheet.classList.contains('hidden')) return;
            if (force) {
                sheet.classList.add('hidden');
                sheet.classList.remove('active');
                return;
            }
            sheet.classList.remove('active');
            setTimeout(() => sheet.classList.add('hidden'), 200);
        }

        function openSharePreview() {
            const preview = document.getElementById('share-preview');
            if (!preview) return;
            const title = document.getElementById('reader-title').innerText || '未命名';
            const bodyEl = document.getElementById('reader-body');
            const content = bodyEl?.dataset?.raw || bodyEl?.innerText || '';
            const payload = getPaperPayload(title, content);
            document.getElementById('share-preview-subtitle').innerText = payload.title;
            renderPaperTo(document.getElementById('share-preview-canvas'), payload);
            closeShare(true);
            preview.classList.remove('hidden');
            requestAnimationFrame(() => preview.classList.add('active'));
        }

        function closeSharePreview(action) {
            const preview = document.getElementById('share-preview');
            if (!preview || preview.classList.contains('hidden')) return;
            if (action === true) {
                preview.classList.add('hidden');
                preview.classList.remove('active');
                return;
            }
            preview.classList.remove('active');
            setTimeout(() => preview.classList.add('hidden'), 200);
            if (action === 'back') setTimeout(() => openShare(), 220);
        }

        async function shareDoc(type) {
            const title = document.getElementById('reader-title').innerText || '未命名';
            const bodyEl = document.getElementById('reader-body');
            const content = bodyEl?.dataset?.raw || bodyEl?.innerText || '';
            const tip = document.getElementById('share-tip');
            const text = `${title}\n\n${content}`.trim();

            try {
                if (type === 'pdf') {
                    openSharePreview();
                    return;
                }
                if (type === 'copy-title') {
                    await copyToClipboard(title);
                    if (tip) tip.innerText = "标题已复制";
                    return;
                }
                if (type === 'copy-all') {
                    await copyToClipboard(text);
                    if (tip) tip.innerText = "全文已复制";
                    return;
                }
                if (type === 'download') {
                    const safeTitle = sanitizeFileName(title);
                    const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${safeTitle}.txt`;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    URL.revokeObjectURL(url);
                    if (tip) tip.innerText = "已生成 TXT 文件";
                }
            } catch (e) {
                if (tip) tip.innerText = "操作失败，请再试一次";
            }
        }

        async function exportToPDF() {
            const title = document.getElementById('reader-title').innerText || 'Document';
            const bodyEl = document.getElementById('reader-body');
            const content = bodyEl?.dataset?.raw || bodyEl?.innerText || '';
            const payload = getPaperPayload(title, content);
            const container = document.getElementById('pdf-staging-area');

            if (!content || !container || typeof html2pdf === 'undefined') {
                renderPrintContent(payload.title, content);
                closeSharePreview(true);
                setTimeout(() => window.print(), 100);
                return;
            }

            renderPaperTo(container, payload);
            const fileName = `${sanitizeFileName(payload.title)}.pdf`;
            const opt = {
                margin: 0,
                filename: fileName,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };

            try {
                const worker = html2pdf().set(opt).from(container).toPdf();
                const pdfBlob = await worker.output('blob');
                if (!pdfBlob || pdfBlob.size < 5000) throw new Error('empty');

                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: payload.title });
                } else {
                    const url = URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    URL.revokeObjectURL(url);
                }
            } catch (err) {
                renderPrintContent(payload.title, content);
                closeSharePreview(true);
                setTimeout(() => window.print(), 120);
            }
        }

        function renderDocs(docs) {
            const list = document.getElementById('doc-list');
            if (!list) return;
            const items = Array.isArray(docs) ? docs : [];
            const count = items.length;
            const words = items.reduce((sum, doc) => sum + countWords(doc.content || ""), 0);
            const readSeconds = items.reduce((sum, doc) => sum + (doc.reading_seconds || 0), 0);
            const approxSeconds = Math.ceil(words / 250) * 60;
            const totalSeconds = Math.max(readSeconds, approxSeconds);

            document.getElementById('stat-count').innerText = count;
            document.getElementById('stat-words').innerText = words.toLocaleString();
            document.getElementById('stat-time').innerText = formatDuration(totalSeconds);

            if (!count) {
                list.innerHTML = '<div style="color:var(--text-sec);padding:20px;text-align:center;">暂无文档</div>';
                return;
            }

            list.innerHTML = items.map((doc) => {
                const title = escapeHtml(doc.title || '无标题');
                const rawPreview = (doc.content || '').replace(/\s+/g, ' ').trim();
                const previewText = rawPreview.length > 180 ? `${rawPreview.slice(0, 180)}...` : rawPreview;
                const preview = escapeHtml(previewText);
                const date = doc.created_at ? new Date(doc.created_at).toLocaleDateString() : '';
                return `
                    <div class="doc-item" onclick="openReader('${doc.id}')">
                        <div>
                            <h3 style="margin-top:0;font-size:18px;">${title}</h3>
                            <div class="doc-preview">${preview}</div>
                        </div>
                        <div class="doc-footer">
                            <span>${date}</span>
                            <button class="btn-icon-danger" onclick="event.stopPropagation(); deleteDoc('${doc.id}')" title="删除文章">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadDocs(options = {}) {
            const { useCache = true } = options;
            const list = document.getElementById('doc-list');
            const cached = useCache ? getDocsCache() : null;

            if (cached && cached.length) renderDocs(cached);
            else if (list) list.innerHTML = '加载中...';

            const { data, error } = await db.from('articles').select('*').order('created_at', { ascending: false });
            if (error) {
                if ((!cached || !cached.length) && list) {
                    list.innerHTML = '<div style="color:var(--text-sec);padding:20px;text-align:center;">加载失败</div>';
                }
                return;
            }

            const docs = data || [];
            if (!cached || !docsEqual(docs, cached)) {
                setDocsCache(docs);
                renderDocs(docs);
            }
        }

        window.deleteDoc = async (id) => {
            if (confirm("确定删除这篇文章吗？")) {
                const { error } = await db.from('articles').delete().eq('id', id);
                if (error) {
                    alert("删除失败，请检查 RLS 策略");
                } else {
                    removeDocFromCache(id);
                    renderDocs(getDocsCache() || []);
                    if (currentDocId === id) closeReader();
                }
            }
        };

        function applyReaderData(data, options = {}) {
            if (!data) return;
            document.getElementById('reader-title').innerText = data.title || '未命名';
            const div = document.getElementById('reader-body');
            div.innerText = data.content || '';
            div.dataset.raw = data.content || '';
            applyFontStyle(localStorage.getItem('pref_font') || 'system', localStorage.getItem('pref_size') || '18');
            if (options.resetTimer) {
                startReadingTimer(data.reading_seconds || 0);
            } else if (typeof data.reading_seconds === 'number') {
                docTotalSeconds = data.reading_seconds;
                updateTimerDisplay();
            }
        }

        async function openReader(id) {
            if (!id) return;
            stopReadingTimer();
            currentDocId = id;
            activeNotes = [];
            document.getElementById('view-reader').classList.remove('hidden');
            const notesList = document.getElementById('reader-notes-list');
            if (notesList) notesList.innerHTML = '';

            const cached = getDocCache(id);
            if (cached) {
                applyReaderData(cached, { resetTimer: true });
                loadAnnotations(id, { useCache: true });
            } else {
                document.getElementById('reader-title').innerText = '加载中...';
                const readerBody = document.getElementById('reader-body');
                readerBody.innerText = '';
                readerBody.dataset.raw = '';
            }

            const { data } = await db.from('articles').select('*').eq('id', id).single();
            if (!data) return;
            setDocCache(data);
            applyReaderData(data, { resetTimer: !cached });
            loadAnnotations(id, { useCache: false });
        }

        function renderAnnotations(notes) {
            const contentDiv = document.getElementById('reader-body');
            const listDiv = document.getElementById('reader-notes-list');
            if (!contentDiv || !listDiv) return;

            const rawText = contentDiv.dataset.raw || '';
            activeNotes = Array.isArray(notes) ? notes : [];
            listDiv.innerHTML = '';

            if (!rawText) {
                contentDiv.innerText = '';
                listDiv.innerHTML = '<div style="color:var(--text-sec);text-align:center;">暂无笔记</div>';
                return;
            }

            if (!activeNotes.length) {
                contentDiv.innerText = rawText;
                listDiv.innerHTML = '<div style="color:var(--text-sec);text-align:center;">暂无笔记</div>';
                return;
            }

            let html = "";
            let lastIndex = 0;
            activeNotes.forEach((n) => {
                const start = Math.max(0, n.start_index || 0);
                const end = Math.min(rawText.length, n.end_index || 0);
                if (start < lastIndex || end <= start) return;
                html += escapeHtml(rawText.substring(lastIndex, start));
                const exactText = rawText.substring(start, end);
                const safeNote = (n.note || '').replace(/'/g, "\\'").replace(/\n/g, " ");
                html += `<span class="highlight" onclick="handleHighlightClick('${n.id}', '${safeNote}')">${escapeHtml(exactText)}</span>`;
                lastIndex = end;
                listDiv.innerHTML += `
                    <div class="note-card">
                        <div class="note-quote">"${escapeHtml(exactText)}"</div>
                        <div class="note-text">${escapeHtml(n.note || '')}</div>
                        <div style="text-align:right;margin-top:8px;">
                            <button class="btn-text danger" style="padding:0;font-size:12px;" onclick="window.deleteNote('${n.id}')">删除</button>
                        </div>
                    </div>
                `;
            });
            html += escapeHtml(rawText.substring(lastIndex));
            contentDiv.innerHTML = html;
        }

        async function loadAnnotations(id, options = {}) {
            const { useCache = true, silent = false } = options;
            const cached = useCache ? getNotesCache(id) : null;
            if (cached) renderAnnotations(cached);

            const { data, error } = await db.from('annotations').select('*').eq('article_id', id).order('start_index', { ascending: true });
            if (error) {
                if (!silent) console.warn(error);
                return;
            }

            const notes = data || [];
            if (!cached || !notesEqual(notes, cached)) {
                setNotesCache(id, notes);
                if (id === currentDocId) renderAnnotations(notes);
            }
        }

        function handleSelection(e) {
            if (e.target.classList.contains('highlight')) return;
            if (!currentDocId) return;
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return;
            const text = sel.toString().trim();
            if (!text) return;

            const range = sel.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(document.getElementById('reader-body'));
            preCaretRange.setEnd(range.startContainer, range.startOffset);
            const startIndex = preCaretRange.toString().length;
            const endIndex = startIndex + text.length;

            const overlap = activeNotes.find((n) =>
                (startIndex >= n.start_index && startIndex < n.end_index) ||
                (endIndex > n.start_index && endIndex <= n.end_index) ||
                (startIndex <= n.start_index && endIndex >= n.end_index)
            );

            if (overlap) {
                if (confirm(`该区域已有笔记：\n"${overlap.note}"\n\n是否修改？`)) {
                    const newNote = prompt("修改笔记:", overlap.note);
                    if (newNote && newNote !== overlap.note) {
                        db.from('annotations').update({ note: newNote }).eq('id', overlap.id).then(() => loadAnnotations(currentDocId, { useCache: false }));
                    }
                }
                sel.removeAllRanges();
                return;
            }

            setTimeout(async () => {
                const note = prompt("添加笔记:");
                if (note) {
                    await db.from('annotations').insert({
                        article_id: currentDocId,
                        highlight_text: text,
                        start_index: startIndex,
                        end_index: endIndex,
                        note
                    });
                    loadAnnotations(currentDocId, { useCache: false });
                }
                sel.removeAllRanges();
            }, 10);
        }

        window.handleHighlightClick = (id, text) => {
            event.stopPropagation();
            if (confirm(`已存在笔记：\n"${text}"\n\n要删除它吗？`)) window.deleteNote(id);
        };

        window.deleteNote = async (id) => {
            const { error } = await db.from('annotations').delete().eq('id', id);
            if (error) alert("删除失败: " + error.message);
            else loadAnnotations(currentDocId, { useCache: false });
        };

        function isEditorOpen() {
            const editor = document.getElementById('view-editor');
            return editor && !editor.classList.contains('hidden');
        }

        function applyEditorData(data, options = {}) {
            if (!data) return;
            const { preserveSelection = false } = options;
            const editorEl = getEditorEl();
            const selection = preserveSelection && editorEl && document.activeElement === editorEl
                ? getSelectionOffsets(editorEl)
                : null;
            setTitleValue(data.title || '', { silent: true });
            setEditorContent(data.content || '', { silent: true });
            if (selection && editorEl) restoreSelectionOffsets(editorEl, selection.anchor, selection.head);
        }

        function syncEditorFromRealtime(data) {
            if (!isEditorOpen()) return;
            const editorEl = getEditorEl();
            const titleEl = getTitleEl();
            if (!editorEl || !titleEl) return;
            const incomingTitle = normalizeTitleText(data.title || '');
            const incomingContent = normalizeEditorText(data.content || '');
            const localTitle = normalizeTitleText(getEditorValue(titleEl));
            const localContent = normalizeEditorText(getEditorValue(editorEl));
            if (incomingTitle === localTitle && incomingContent === localContent) return;
            const active = document.activeElement;
            if (active === editorEl || active === titleEl) return;
            applyEditorData(data, { preserveSelection: true });
        }

        async function openEditor(id) {
            currentDocId = id;
            document.getElementById('view-editor').classList.remove('hidden');
            setTitleValue('', { silent: true });
            setEditorContent('', { silent: true });
            document.getElementById('save-status').innerText = '准备就绪';

            if (editorHistory) {
                editorHistory.stack = [];
                editorHistory.pointer = -1;
            }

            if (id) {
                let initialTitle = '';
                let initialContent = '';
                const cached = getDocCache(id);
                if (cached) {
                    initialTitle = cached.title || '';
                    setTitleValue(initialTitle, { silent: true });
                    initialContent = cached.content || '';
                    setEditorContent(initialContent, { silent: true });
                    if (editorHistory) editorHistory.save(initialContent);
                }
                setupCollaboration(id, initialContent, initialTitle);

                const { data } = await db.from('articles').select('*').eq('id', id).single();
                if (data) {
                    setDocCache(data);
                    initialTitle = data.title || '';
                    setTitleValue(initialTitle, { silent: true });
                    initialContent = data.content || '';
                    setEditorContent(initialContent, { silent: true });
                    if (editorHistory) {
                        editorHistory.stack = [];
                        editorHistory.pointer = -1;
                        editorHistory.save(initialContent);
                    }
                    setupCollaboration(id, initialContent, initialTitle);
                }
            } else {
                teardownCollaboration();
            }
        }

        function closeEditor() {
            document.getElementById('view-editor').classList.add('hidden');
            teardownCollaboration();
            showPage('dashboard');
        }

        function triggerAutoSave() {
            document.getElementById('save-status').innerText = "输入中...";
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => saveDoc(false), 2000);
            scheduleAwarenessUpdate();
        }

        async function saveDoc(close, options = {}) {
            const { silent = false } = options;
            const t = getTitleValue();
            const c = getEditorContent();
            if (!t && !c && close) return closeEditor();
            if (!silent) document.getElementById('save-status').innerText = "保存中...";
            const payload = { title: t, content: c, user_id: currentUser.id };
            let saved = null;

            if (currentDocId) {
                const { data } = await db.from('articles').update(payload).eq('id', currentDocId).select().single();
                saved = data;
            } else {
                const res = await db.from('articles').insert(payload).select();
                if (res.data) {
                    currentDocId = res.data[0].id;
                    saved = res.data[0];
                }
            }

            if (saved) setDocCache(saved);
            else updateDocsCache({ ...payload, id: currentDocId });

            if (!collabRoomId && currentDocId) setupCollaboration(currentDocId, c, t);

            if (!silent) document.getElementById('save-status').innerText = "已保存";
            if (close) {
                closeEditor();
                loadDocs({ useCache: true });
            }
        }

        async function updateName() {
            const n = document.getElementById('set-name').value;
            if (n) {
                await db.auth.updateUser({ data: { full_name: n } });
                document.getElementById('nav-name').innerText = n;
                if (collabAwareness) {
                    collabAwareness.setLocalStateField('user', {
                        name: n,
                        color: getCollabColor()
                    });
                }
                alert("已更新");
            }
        }

        async function sendPasswordReset() {
            if (currentUser) {
                const { error } = await db.auth.resetPasswordForEmail(currentUser.email, { redirectTo: window.location.href });
                alert(error ? error.message : "邮件已发送");
            }
        }

        async function uploadAvatar(inp) {
            const f = inp.files[0];
            if (!f) return;
            document.getElementById('setting-avatar-preview').src = URL.createObjectURL(f);
            try {
                const path = `${currentUser.id}/${Date.now()}`;
                await db.storage.from('avatars').upload(path, f);
                const { data } = db.storage.from('avatars').getPublicUrl(path);
                await db.auth.updateUser({ data: { avatar_url: data.publicUrl } });
                document.getElementById('nav-avatar').src = data.publicUrl;
                alert("头像更新成功");
            } catch (e) {
                alert("上传失败");
            }
        }

        function showPage(id) {
            ['dashboard', 'settings'].forEach((p) => document.getElementById('page-' + p).classList.add('hidden'));
            document.getElementById('page-' + id).classList.remove('hidden');
            const isDash = id === 'dashboard';
            document.getElementById('tab-dash-pc').classList.toggle('active', isDash);
            document.getElementById('tab-set-pc').classList.toggle('active', !isDash);
            document.getElementById('tab-dash-mb').classList.toggle('active', isDash);
            document.getElementById('tab-set-mb').classList.toggle('active', !isDash);
            if (isDash) loadDocs({ useCache: true });
        }

        function closeReader() {
            closeShare(true);
            closeSharePreview(true);
            stopReadingTimer();
            currentDocId = null;
            activeNotes = [];
            document.getElementById('view-reader').classList.add('hidden');
            showPage('dashboard');
        }

        function switchToEdit() {
            closeShare(true);
            closeSharePreview(true);
            stopReadingTimer();
            document.getElementById('view-reader').classList.add('hidden');
            openEditor(currentDocId);
        }

        async function signOut() {
            stopReadingTimer();
            unsubscribeRealtime();
            teardownCollaboration();
            clearDocCache();
            await db.auth.signOut();
            localStorage.removeItem('remember');
            sessionStorage.removeItem('active');
            location.reload();
        }

        function setTheme(v) {
            const value = v || 'system';
            localStorage.setItem('pref_theme', value);
            const isDark = value === 'dark' || (value === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
        }

        function subscribeRealtime() {
            if (realtimeChannel) return;
            realtimeChannel = db.channel('sr-realtime')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'articles' }, handleArticleChange)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'annotations' }, handleAnnotationChange)
                .subscribe();
        }

        function unsubscribeRealtime() {
            if (!realtimeChannel) return;
            db.removeChannel(realtimeChannel);
            realtimeChannel = null;
        }

        function handleArticleChange(payload) {
            if (!payload) return;
            if (payload.eventType === 'DELETE') {
                removeDocFromCache(payload.old.id);
                if (currentDocId === payload.old.id) closeReader();
            } else {
                updateDocsCache(payload.new);
                if (currentDocId && payload.new.id === currentDocId) {
                    applyReaderData(payload.new, { resetTimer: false });
                    syncEditorFromRealtime(payload.new);
                    const cachedNotes = getNotesCache(currentDocId);
                    if (cachedNotes) renderAnnotations(cachedNotes);
                }
            }
            const dashboard = document.getElementById('page-dashboard');
            if (dashboard && !dashboard.classList.contains('hidden')) {
                renderDocs(getDocsCache() || []);
            }
        }

        function handleAnnotationChange(payload) {
            if (!payload) return;
            const docId = (payload.new || payload.old || {}).article_id;
            if (!docId) return;

            let notes = getNotesCache(docId) || [];
            if (payload.eventType === 'DELETE') {
                notes = notes.filter((note) => note.id !== payload.old.id);
            } else {
                const row = payload.new;
                const idx = notes.findIndex((note) => note.id === row.id);
                if (idx >= 0) notes[idx] = row;
                else notes.push(row);
            }
            notes = notes.sort((a, b) => (a.start_index || 0) - (b.start_index || 0));
            setNotesCache(docId, notes);
            if (docId === currentDocId) renderAnnotations(notes);
        }

        init();
    </script>
</body>

</html>
