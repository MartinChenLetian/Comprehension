<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Reader Pro</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ================== Design System ================== */
        :root {
            --primary: #007AFF; 
            --bg-body: #F5F5F7;
            --bg-card: #FFFFFF;
            --bg-sidebar: rgba(250, 250, 250, 0.95);
            --text-main: #1D1D1F;
            --text-sec: #86868B;
            --separator: rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        }

        [data-theme="dark"] {
            --bg-body: #000000;
            --bg-card: #1C1C1E;
            --bg-sidebar: rgba(28, 28, 30, 0.95);
            --text-main: #F5F5F7;
            --text-sec: #86868B;
            --separator: rgba(255, 255, 255, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-stack); background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* Buttons */
        .btn { border: none; outline: none; cursor: pointer; font-family: inherit; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; border-radius: 8px; padding: 8px 20px; font-size: 14px; }
        .btn-text { background: transparent; color: var(--primary); padding: 6px 12px; font-size: 14px; border-radius: 6px; }
        .btn-text.danger { color: #FF3B30; }
        .btn-back { background: transparent; color: var(--text-sec); font-size: 15px; padding: 8px 12px; border-radius: 8px; }
        .btn-circle { width: 44px; height: 44px; border-radius: 50%; background: var(--primary); color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-shrink: 0; }
        .btn-icon-danger { background: transparent; color: #FF3B30; padding: 8px; border-radius: 50%; font-size: 18px; transition: 0.2s; }
        
        .input-clean { width: 100%; padding: 12px; background: rgba(120, 120, 128, 0.1); border: 1px solid transparent; border-radius: 10px; color: var(--text-main); font-size: 16px; }
        .input-clean:focus { background: var(--bg-card); border-color: var(--primary); outline: none; }

        /* Layout */
        .app-container { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--separator); padding: 24px 16px; display: flex; flex-direction: column; flex-shrink: 0; backdrop-filter: blur(20px); }
        .main-content { flex: 1; overflow-y: auto; padding: 40px; position: relative; }
        
        .user-card { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; margin-bottom: 20px; }
        .user-avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; background: #eee; border: 1px solid var(--separator); }
        .nav-item { padding: 10px 12px; border-radius: 8px; color: var(--text-sec); font-size: 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
        .nav-item.active { background: rgba(0,0,0,0.05); color: var(--text-main); font-weight: 600; }

        /* Dashboard */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; height: 50px; }
        .page-title { font-size: 30px; font-weight: 700; letter-spacing: -0.5px; }
        .stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 40px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: var(--radius); border: 1px solid var(--separator); }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--text-main); }
        
        .doc-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; padding-bottom: 100px; }
        .doc-item { background: var(--bg-card); padding: 24px; border-radius: var(--radius); height: auto; min-height: 180px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--separator); cursor: pointer; transition: 0.2s; position: relative; }
        .doc-item:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .doc-preview { font-size: 14px; color: var(--text-sec); overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; line-height: 1.6; margin-top: 10px; margin-bottom: 20px; }
        .doc-footer { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-sec); }

        /* Reader */
        .reader-layout { display: flex; height: calc(100vh - 60px); }
        .reader-text-area { flex: 2; padding: 60px; overflow-y: auto; border-right: 1px solid var(--separator); background: var(--bg-card); position: relative; }
        .reader-notes-area { flex: 1; padding: 24px; background: var(--bg-body); overflow-y: auto; min-width: 320px; }
        
        /* 关键：保留空白符，确保索引准确 */
        .reader-content { white-space: pre-wrap; color: var(--text-main); line-height: 1.8; word-wrap: break-word; }
        
        .highlight { background-color: rgba(255, 214, 10, 0.4); border-bottom: 2px solid #FFD60A; cursor: pointer; border-radius: 2px; }
        .highlight:hover { background-color: rgba(255, 214, 10, 0.7); }
        
        .note-card { background: var(--bg-card); padding: 16px; border-radius: 12px; margin-bottom: 16px; border: 1px solid var(--separator); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .note-quote { border-left: 3px solid #FFD60A; padding-left: 8px; color: var(--text-sec); font-size: 12px; margin-bottom: 8px; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .note-text { font-size: 14px; color: var(--text-main); line-height: 1.5; }

        /* Editor & Common */
        .overlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 100; display: flex; flex-direction: column; }
        .toolbar { height: 60px; background: var(--bg-card); border-bottom: 1px solid var(--separator); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .toolbar-control { background: rgba(0,0,0,0.05); border: none; border-radius: 6px; padding: 6px 10px; font-size: 13px; color: var(--text-main); margin-left: 8px; }
        .editor-area { flex: 1; max-width: 800px; width: 100%; margin: 0 auto; padding: 40px; overflow-y: auto; }
        #doc-title { font-size: 32px; font-weight: 800; border: none; background: transparent; width: 100%; margin-bottom: 24px; color: var(--text-main); }
        #doc-body { width: 100%; min-height: 60vh; border: none; background: transparent; resize: none; outline: none; color: var(--text-main); }

        /* Auth */
        .auth-split { display: flex; height: 100vh; }
        .auth-img { flex: 1.5; background: #000; position: relative; }
        .auth-img div { position: absolute; inset: 0; background-size: cover; background-position: center; transition: opacity 1s; opacity: 0; }
        .auth-img div.active { opacity: 1; }
        .auth-form { flex: 1; max-width: 480px; background: var(--bg-body); display: flex; flex-direction: column; justify-content: center; padding: 60px; }

        .mobile-tab-bar { display: none; }
        @media (max-width: 768px) {
            .auth-split { flex-direction: column; } .auth-img { display: none; } .auth-form { max-width: 100%; padding: 40px 24px; }
            .sidebar { display: none; }
            .mobile-tab-bar { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--separator); padding-bottom: env(safe-area-inset-bottom); z-index: 90; justify-content: space-around; }
            .tab-item { flex: 1; text-align: center; padding: 10px 0; color: var(--text-sec); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; }
            .tab-item.active { color: var(--primary); }
            .main-content { padding: 20px 16px 100px 16px; }
            .reader-layout { flex-direction: column; }
            .reader-text-area { padding: 20px; border-right: none; height: auto; overflow: visible; }
            .reader-notes-area { height: auto; min-width: 100%; border-top: 1px solid var(--separator); padding-bottom: 100px; }
            .stats-container, .doc-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="view-auth" class="auth-split">
        <div class="auth-img"><div id="bg-1" class="active"></div><div id="bg-2"></div></div>
        <div class="auth-form">
            <h1 style="margin-bottom:10px;">Smart Reader</h1>
            <p style="color:var(--text-sec); margin-bottom:40px;">极简创作与沉浸阅读</p>
            <input type="email" id="email" class="input-clean" placeholder="邮箱" style="margin-bottom:16px;">
            <input type="password" id="password" class="input-clean" placeholder="密码" style="margin-bottom:24px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:30px; font-size:14px; color:var(--text-sec);">
                <label style="display:flex; gap:6px;"><input type="checkbox" id="remember"> 14天免登录</label>
                <a onclick="toggleAuth()" style="color:var(--primary); cursor:pointer;">注册账号</a>
            </div>
            <button class="btn-primary" onclick="handleAuth()" style="width:100%; height:48px;" id="auth-btn">登录</button>
            <div id="auth-msg" style="text-align:center; color:#FF3B30; margin-top:16px; font-size:14px;"></div>
        </div>
    </div>

    <div id="view-app" class="app-container hidden">
        <nav class="sidebar">
            <div class="user-card" style="margin-bottom:20px; cursor:default;">
                <img id="nav-avatar" style="width:44px; height:44px; border-radius:50%; object-fit:cover; background:#eee;">
                <div style="margin-left:12px; overflow:hidden;"><div style="font-weight:600;" id="nav-name">User</div><div style="font-size:12px; color:var(--text-sec);">已登录</div></div>
            </div>
            <div class="nav-item active" onclick="showPage('dashboard')" id="tab-dash-pc"><i class="ph ph-squares-four" style="font-size:20px;"></i> 文库</div>
            <div class="nav-item" onclick="showPage('settings')" id="tab-set-pc"><i class="ph ph-gear" style="font-size:20px;"></i> 设置</div>
            <div style="margin-top:auto;"><div class="nav-item" onclick="signOut()" style="color:#FF3B30;"><i class="ph ph-sign-out" style="font-size:20px;"></i> 退出</div></div>
        </nav>

        <main class="main-content">
            <div id="page-dashboard">
                <div class="page-header"><div class="page-title">文库</div><button class="btn btn-circle" onclick="openEditor(null)"><i class="ph ph-plus"></i></button></div>
                <div class="stats-container">
                    <div class="stat-card"><div class="stat-label">ARTICLES</div><div class="stat-value" id="stat-count">0</div></div>
                    <div class="stat-card"><div class="stat-label">WORDS</div><div class="stat-value" id="stat-words">0</div></div>
                    <div class="stat-card"><div class="stat-label">TIME</div><div class="stat-value" id="stat-time">0m</div></div>
                </div>
                <div id="doc-list" class="doc-list">加载中...</div>
            </div>

            <div id="page-settings" class="hidden">
                <div class="page-header"><div class="page-title">设置</div></div>
                <div style="max-width:600px; margin:0 auto;">
                    <div style="background:var(--bg-card); border-radius:12px; border:1px solid var(--separator); overflow:hidden; margin-bottom:24px;">
                        <div style="padding:16px; border-bottom:1px solid var(--separator); display:flex; justify-content:space-between; align-items:center;">
                            <span>昵称</span><div style="display:flex; gap:10px;"><input type="text" id="set-name" class="input-clean" style="width:120px; padding:6px;"><button class="btn-text" onclick="updateName()">保存</button></div>
                        </div>
                        <div style="padding:16px; border-bottom:1px solid var(--separator); display:flex; justify-content:space-between; align-items:center;">
                            <span>头像</span><div style="display:flex; align-items:center; gap:10px;"><img id="setting-avatar-preview" style="width:36px; height:36px; border-radius:50%; object-fit:cover;"><input type="file" id="avatar-upload" hidden onchange="uploadAvatar(this)"><button class="btn-text" onclick="document.getElementById('avatar-upload').click()">更换</button></div>
                        </div>
                        <div style="padding:16px; display:flex; justify-content:space-between; align-items:center;">
                            <span>重置密码</span><button class="btn-text danger" onclick="sendPasswordReset()">发送邮件</button>
                        </div>
                    </div>
                    <div style="background:var(--bg-card); border-radius:12px; border:1px solid var(--separator); overflow:hidden;">
                        <div style="padding:16px; display:flex; justify-content:space-between; align-items:center;">
                            <span>深色模式</span><select class="toolbar-control" onchange="setTheme(this.value)"><option value="system">系统</option><option value="light">浅色</option><option value="dark">深色</option></select>
                        </div>
                    </div>
                    <div class="settings-group" style="border:none; background:transparent; margin-top:20px; display:none;" id="mobile-logout">
                        <button class="btn-primary" style="width:100%; background:#FF3B30;" onclick="signOut()">退出登录</button>
                    </div>
                </div>
            </div>
        </main>

        <div class="mobile-tab-bar">
            <div class="tab-item active" onclick="showPage('dashboard')" id="tab-dash-mb"><i class="ph ph-squares-four" style="font-size:24px;"></i><span style="font-size:10px;">文库</span></div>
            <div class="tab-item" onclick="openEditor(null)"><i class="ph ph-plus-circle" style="font-size:28px; color:var(--primary);"></i></div>
            <div class="tab-item" onclick="showPage('settings')" id="tab-set-mb"><i class="ph ph-gear" style="font-size:24px;"></i><span style="font-size:10px;">设置</span></div>
        </div>
    </div>

    <div id="view-editor" class="overlay hidden">
        <div class="toolbar">
            <button class="btn-back" onclick="closeEditor()"><i class="ph ph-caret-left"></i> 返回</button>
            <div style="display:flex; align-items:center;">
                <select id="editor-font" class="toolbar-control" onchange="syncFont()"><option value="system">Sans</option><option value="serif">Serif</option><option value="mono">Mono</option></select>
                <input type="number" id="editor-size" class="toolbar-control num-input" value="18" onchange="validateFontSize(this)" oninput="syncFont()">
            </div>
            <div style="display:flex; gap:8px; align-items:center;"><span id="save-status" style="font-size:11px; color:var(--text-sec);">已保存</span><button class="btn-text" style="font-weight:600;" onclick="saveDoc(true)">完成</button></div>
        </div>
        <div class="editor-area">
            <input type="text" id="doc-title" placeholder="输入标题" onkeyup="triggerAutoSave()">
            <textarea id="doc-body" placeholder="输入正文..." onkeyup="triggerAutoSave()"></textarea>
        </div>
    </div>

    <div id="view-reader" class="overlay hidden">
        <div class="toolbar">
            <button class="btn-back" onclick="closeReader()"><i class="ph ph-caret-left"></i> 返回</button>
            <div style="display:flex; align-items:center;">
                <select id="reader-font-select" class="toolbar-control" onchange="syncReaderFont()"><option value="system">Sans</option><option value="serif">Serif</option><option value="mono">Mono</option></select>
                <input type="number" id="reader-size-input" class="toolbar-control num-input" value="18" onchange="validateFontSize(this)" oninput="syncReaderFont()">
            </div>
            <button class="btn-text" onclick="switchToEdit()">编辑</button>
        </div>
        <div class="reader-layout">
            <div class="reader-text-area">
                <h1 id="reader-title" style="margin-bottom:30px; font-size:32px; font-weight:800;"></h1>
                <div id="reader-body" class="reader-content"></div>
            </div>
            <div class="reader-notes-area">
                <div style="font-size:12px; font-weight:700; color:var(--text-sec); margin-bottom:15px; text-transform:uppercase;">笔记</div>
                <div id="reader-notes-list"></div>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://oktgxeukllgglharkutf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rdGd4ZXVrbGxnZ2xoYXJrdXRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNzI1MTAsImV4cCI6MjA4MDY0ODUxMH0.R-XORb7qYMZPGLj4ZdPt3bIrI61TgOs7vCyxwGmnCpg';
        const db = supabase.createClient(supabaseUrl, supabaseKey);

        const bgImages = ['https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2000', 'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=2000', 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2000'];
        let currentUser=null, isSignup=false, currentDocId=null, saveTimer=null, bgIdx=0;
        let activeNotes = []; 

        async function init() {
            setInterval(() => {
                bgIdx = (bgIdx + 1) % bgImages.length;
                const active = document.querySelector('.auth-img div.active');
                if(active) {
                    const next = active.id === 'bg-1' ? document.getElementById('bg-2') : document.getElementById('bg-1');
                    next.style.backgroundImage = `url('${bgImages[bgIdx]}')`; next.classList.add('active'); active.classList.remove('active');
                }
            }, 6000);
            if(document.getElementById('bg-1')) document.getElementById('bg-1').style.backgroundImage = `url('${bgImages[0]}')`;

            const font=localStorage.getItem('pref_font')||'system', size=localStorage.getItem('pref_size')||'18';
            document.getElementById('editor-font').value=font; document.getElementById('editor-size').value=size;
            document.getElementById('reader-font-select').value=font; document.getElementById('reader-size-input').value=size;
            applyFontStyle(font, size);

            const { data: { session } } = await db.auth.getSession();
            if (session && (localStorage.getItem('remember') || sessionStorage.getItem('active'))) {
                sessionStorage.setItem('active', 'true'); updateUser(session.user);
            }
            if(window.innerWidth < 768) document.getElementById('mobile-logout').style.display = 'block';
        }

        function validateFontSize(input) {
            let val = parseInt(input.value); if(isNaN(val)||val<16) val=16; if(val>42) val=42; input.value=val;
            input.id==='editor-size'?syncFont():syncReaderFont();
        }
        function syncFont() { saveAndApply(document.getElementById('editor-font').value, document.getElementById('editor-size').value); }
        function syncReaderFont() { saveAndApply(document.getElementById('reader-font-select').value, document.getElementById('reader-size-input').value); }
        function saveAndApply(f, s) {
            localStorage.setItem('pref_font',f); localStorage.setItem('pref_size',s);
            ['editor-font','reader-font-select'].forEach(id=>document.getElementById(id).value=f);
            ['editor-size','reader-size-input'].forEach(id=>document.getElementById(id).value=s);
            applyFontStyle(f,s);
        }
        function applyFontStyle(f, s) {
            const fonts={'system':'-apple-system, sans-serif','serif':'Georgia, serif','mono':'Menlo, monospace'};
            const cssF=fonts[f], cssS=s+'px';
            ['doc-body','reader-body'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.style.fontFamily=cssF; el.style.fontSize=cssS; } });
        }

        async function handleAuth() {
            const email=document.getElementById('email').value, password=document.getElementById('password').value;
            const btn=document.getElementById('auth-btn'), msg=document.getElementById('auth-msg');
            if(!email||!password) return msg.innerText="请填写完整";
            btn.innerText="处理中...";
            let res;
            if(isSignup) res = await db.auth.signUp({email, password});
            else res = await db.auth.signInWithPassword({email, password});
            
            if(res.error) { msg.innerText=res.error.message; btn.innerText=isSignup?"注册":"登录"; }
            else {
                if(isSignup && !res.data.session) { msg.innerText="验证邮件已发送"; isSignup=false; btn.innerText="登录"; }
                else {
                    if(document.getElementById('remember').checked) localStorage.setItem('remember', 'true');
                    sessionStorage.setItem('active', 'true'); updateUser(res.data.user);
                }
            }
        }
        function toggleAuth() { isSignup=!isSignup; document.getElementById('auth-btn').innerText=isSignup?"注册":"登录"; }
        function updateUser(user) {
            currentUser=user; document.getElementById('view-auth').classList.add('hidden'); document.getElementById('view-app').classList.remove('hidden');
            const name=user.user_metadata?.full_name||user.email.split('@')[0], avatar=user.user_metadata?.avatar_url||`https://api.dicebear.com/7.x/initials/svg?seed=${name}`;
            document.getElementById('nav-name').innerText=name; document.getElementById('nav-avatar').src=avatar;
            document.getElementById('setting-avatar-preview').src=avatar; document.getElementById('set-name').value=name;
            showPage('dashboard');
        }

        function countWords(s){ return s?s.trim().split(/\s+/).length:0; }
        
        async function loadDocs() {
            const list=document.getElementById('doc-list'); list.innerHTML='Loading...';
            const {data}=await db.from('articles').select('*').order('created_at',{ascending:false});
            let c=0, w=0;
            if(data&&data.length){ c=data.length; data.forEach(d=>w+=countWords(d.content||"")); }
            document.getElementById('stat-count').innerText=c; document.getElementById('stat-words').innerText=w.toLocaleString();
            document.getElementById('stat-time').innerText=Math.ceil(w/250)+"m";
            if(!data||!data.length) return list.innerHTML='<div style="color:var(--text-sec);padding:20px;text-align:center;">暂无文档</div>';
            list.innerHTML=data.map(d=>`
                <div class="doc-item" onclick="openReader('${d.id}')">
                    <div><h3 style="margin-top:0;font-size:18px;">${d.title||'无标题'}</h3><div class="doc-preview">${d.content}</div></div>
                    <div class="doc-footer">
                        <span>${new Date(d.created_at).toLocaleDateString()}</span>
                        <button class="btn-icon-danger" onclick="event.stopPropagation(); deleteDoc('${d.id}')" title="删除文章"><i class="ph ph-trash"></i></button>
                    </div>
                </div>`).join('');
        }

        window.deleteDoc = async (id) => {
            if(confirm("确定删除这篇文章吗？")) {
                const { error } = await db.from('articles').delete().eq('id', id);
                if(error) alert("删除失败，请检查 RLS 策略");
                else loadDocs();
            }
        };

        async function openReader(id) {
            currentDocId=id; document.getElementById('view-reader').classList.remove('hidden');
            const {data}=await db.from('articles').select('*').eq('id',id).single();
            if(!data) return alert("Error");
            document.getElementById('reader-title').innerText=data.title;
            const div=document.getElementById('reader-body'); 
            
            // 核心修复：纯文本渲染
            div.innerText = data.content; 
            div.dataset.raw = data.content; // Store raw text for re-rendering logic

            applyFontStyle(localStorage.getItem('pref_font')||'system', localStorage.getItem('pref_size')||'18');
            loadAnnotations(id);
        }

        // ================= NEW: INDEX-BASED HIGHLIGHTING (精准定位) =================
        
        async function loadAnnotations(id) {
            const {data} = await db.from('annotations').select('*').eq('article_id',id).order('start_index', {ascending: true});
            activeNotes = data || []; // Update cache
            
            const contentDiv = document.getElementById('reader-body');
            const listDiv = document.getElementById('reader-notes-list');
            listDiv.innerHTML = '';
            
            const rawText = contentDiv.dataset.raw;
            if (!rawText) return;

            if (data && data.length > 0) {
                // 重建 HTML：通过切片拼接
                let html = "";
                let lastIndex = 0;

                data.forEach(n => {
                    // 安全检查：如果数据库里的索引超出了文本长度（比如文章被修改过），则跳过
                    if (n.start_index >= rawText.length || n.end_index > rawText.length) return;

                    // 1. 添加高亮前的普通文本
                    html += escapeHtml(rawText.substring(lastIndex, n.start_index));
                    
                    // 2. 添加高亮文本 span
                    const highlightText = escapeHtml(rawText.substring(n.start_index, n.end_index));
                    const safeNote = n.note.replace(/'/g, "\\'").replace(/\n/g, " "); // Escape for JS onclick
                    html += `<span class="highlight" onclick="handleHighlightClick('${n.id}', '${safeNote}')">${highlightText}</span>`;
                    
                    // 3. 更新游标
                    lastIndex = n.end_index;

                    // 渲染侧边栏卡片
                    listDiv.innerHTML += `
                        <div class="note-card">
                            <div class="note-quote">"${highlightText}"</div>
                            <div class="note-text">${n.note}</div>
                            <div style="text-align:right;margin-top:8px;">
                                <button class="btn-text danger" style="padding:0;font-size:12px;" onclick="window.deleteNote('${n.id}')">删除</button>
                            </div>
                        </div>
                    `;
                });

                // 4. 添加剩余文本
                html += escapeHtml(rawText.substring(lastIndex));
                contentDiv.innerHTML = html;
            } else {
                contentDiv.innerText = rawText; // Reset to plain text if no notes
                listDiv.innerHTML = '<div style="color:var(--text-sec);text-align:center;">暂无笔记</div>';
            }
        }

        // HTML 转义防止 XSS
        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // --- Interaction Handlers ---

        window.handleHighlightClick = (id, text) => {
            event.stopPropagation();
            if(confirm(`已存在笔记：\n"${text}"\n\n要删除它吗？`)) window.deleteNote(id); 
        };

        window.deleteNote = async (id) => { 
            const { error } = await db.from('annotations').delete().eq('id',id); 
            if(error) alert("删除失败: " + error.message);
            else loadAnnotations(currentDocId); 
        };
        
        // **核心逻辑：获取选区索引**
        document.getElementById('reader-body').addEventListener('mouseup', (e) => {
            if(e.target.classList.contains('highlight')) return; // Ignore click on existing highlight

            const sel = window.getSelection();
            if (sel.rangeCount === 0) return;
            
            const range = sel.getRangeAt(0);
            const text = sel.toString().trim();
            if (!text) return;

            // 计算 Start Index：这需要黑魔法，因为 DOM 里面可能有 span 标签干扰
            // 简单方案：我们获取 Range 相对于 reader-body 的偏移量
            // 但因为 reader-body 内部已经是复杂的 HTML (包含 span)，直接 getStartOffset 可能会出错
            // 这里为了稳健，我们使用一种 trick：
            // 1. 获取选区前的所有纯文本长度
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(document.getElementById('reader-body'));
            preCaretRange.setEnd(range.startContainer, range.startOffset);
            const startIndex = preCaretRange.toString().length;
            const endIndex = startIndex + text.length;

            // 查重：检查是否区间重叠 (Overlap Check)
            const overlap = activeNotes.find(n => 
                (startIndex >= n.start_index && startIndex < n.end_index) || 
                (endIndex > n.start_index && endIndex <= n.end_index) ||
                (startIndex <= n.start_index && endIndex >= n.end_index)
            );

            if (overlap) {
                alert("此处已包含在现有笔记中，请先删除旧笔记。");
                sel.removeAllRanges();
                return;
            }

            setTimeout(async()=>{
                const note = prompt("添加笔记:");
                if(note) { 
                    const { error } = await db.from('annotations').insert({
                        article_id: currentDocId, 
                        highlight_text: text, // 仅做冗余备份
                        note: note,
                        start_index: startIndex, // 核心定位数据
                        end_index: endIndex      // 核心定位数据
                    });
                    
                    if(error) alert("保存失败: " + error.message);
                    else loadAnnotations(currentDocId); 
                }
                sel.removeAllRanges();
            }, 10);
        });

        async function openEditor(id) {
            currentDocId=id; document.getElementById('view-editor').classList.remove('hidden');
            document.getElementById('doc-title').value=''; document.getElementById('doc-body').value='';
            document.getElementById('save-status').innerText='准备就绪';
            if(id) { const {data}=await db.from('articles').select('*').eq('id',id).single(); document.getElementById('doc-title').value=data.title; document.getElementById('doc-body').value=data.content; }
        }
        function closeEditor(){ document.getElementById('view-editor').classList.add('hidden'); showPage('dashboard'); }
        function triggerAutoSave(){ document.getElementById('save-status').innerText="输入中..."; clearTimeout(saveTimer); saveTimer=setTimeout(()=>saveDoc(false),2000); }
        async function saveDoc(close){
            const t=document.getElementById('doc-title').value, c=document.getElementById('doc-body').value;
            if(!t&&!c&&close) return closeEditor();
            document.getElementById('save-status').innerText="保存中...";
            const pl={title:t, content:c, user_id:currentUser.id};
            if(currentDocId) await db.from('articles').update(pl).eq('id',currentDocId);
            else { const res=await db.from('articles').insert(pl).select(); if(res.data) currentDocId=res.data[0].id; }
            document.getElementById('save-status').innerText="已保存"; if(close) { closeEditor(); loadDocs(); }
        }

        async function updateName(){ 
            const n=document.getElementById('set-name').value; 
            if(n) { await db.auth.updateUser({data:{full_name:n}}); document.getElementById('nav-name').innerText=n; alert("已更新"); } 
        }
        async function sendPasswordReset(){
            if(currentUser) { const {error}=await db.auth.resetPasswordForEmail(currentUser.email,{redirectTo:window.location.href}); alert(error?error.message:"邮件已发送"); }
        }
        async function uploadAvatar(inp){
            const f=inp.files[0]; if(!f) return;
            document.getElementById('setting-avatar-preview').src=URL.createObjectURL(f);
            try {
                const path=`${currentUser.id}/${Date.now()}`;
                await db.storage.from('avatars').upload(path,f);
                const {data}=db.storage.from('avatars').getPublicUrl(path);
                await db.auth.updateUser({data:{avatar_url:data.publicUrl}});
                document.getElementById('nav-avatar').src=data.publicUrl; alert("头像更新成功");
            } catch(e){ alert("上传失败，请检查Bucket权限"); }
        }

        function showPage(id) {
            ['dashboard','settings'].forEach(p=>document.getElementById('page-'+p).classList.add('hidden'));
            document.getElementById('page-'+id).classList.remove('hidden');
            const isDash = id==='dashboard';
            document.getElementById('tab-dash-pc').classList.toggle('active', isDash);
            document.getElementById('tab-set-pc').classList.toggle('active', !isDash);
            document.getElementById('tab-dash-mb').classList.toggle('active', isDash);
            document.getElementById('tab-set-mb').classList.toggle('active', !isDash);
            if(isDash) loadDocs();
        }
        function closeReader(){ document.getElementById('view-reader').classList.add('hidden'); }
        function switchToEdit(){ closeReader(); openEditor(currentDocId); }
        async function signOut(){ await db.auth.signOut(); localStorage.removeItem('remember'); sessionStorage.removeItem('active'); location.reload(); }
        function setTheme(v){ document.body.setAttribute('data-theme', v==='dark'||(v==='system'&&window.matchMedia('(prefers-color-scheme: dark)').matches)?'dark':'light'); }

        init();
    </script>
</body>
</html>
